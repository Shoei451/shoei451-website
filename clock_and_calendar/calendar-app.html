<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="../images/favicon.png" />
  <title>calendar mini app â€” Shoei451</title>
  <link rel="stylesheet" href="../css/calendar_app_styles.css" />
</head>
<body>
  <!-- Auth Screen -->
  <div id="authScreen" class="auth-screen">
    <div class="auth-card">
      <h1>ğŸ“š å­¦ç”Ÿç”¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h1>
      <p>è¤‡æ•°ãƒ‡ãƒã‚¤ã‚¹é–“ã§äºˆå®šã‚’åŒæœŸ</p>
      
      <div id="authError" class="error-message" style="display:none;"></div>
      
      <form id="authForm" class="auth-form">
        <div>
          <label for="authEmail">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
          <input type="email" id="authEmail" required placeholder="your@email.com">
        </div>
        <div>
          <label for="authPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
          <input type="password" id="authPassword" required placeholder="6æ–‡å­—ä»¥ä¸Š">
        </div>
        <button type="submit" id="authSubmit">ãƒ­ã‚°ã‚¤ãƒ³</button>
      </form>
      
      <div class="auth-toggle">
        <span id="authToggleText">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ãªã„å ´åˆ</span>
        <button type="button" id="authToggleBtn">æ–°è¦ç™»éŒ²</button>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div class="app" id="mainApp">
    <header>
      <div class="brand" aria-label="ã‚¢ãƒ—ãƒªå">
        <div class="logo">ğŸ“š</div>
        <h1>å­¦ç”Ÿç”¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ <span class="hint"><br>èª²é¡Œ/è©¦é¨“/æˆæ¥­ã‚’ä¸€æ‹¬ç®¡ç†</span></h1>
      </div>
      
      <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
        <div class="user-info">
          <span id="userEmail"></span>
        </div>
        <div class="sync-status" id="syncStatus">
          <span class="loading-spinner"></span>
          <span>åŒæœŸä¸­...</span>
        </div>
        <button id="theme-toggle" title="ãƒ†ãƒ¼ãƒåˆ‡æ›¿">
          <svg id="moon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
          </svg>
          <svg id="sun" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
          </svg>
        </button>
        <button id="logoutBtn" class="danger">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
      
      <div class="controls">
        <div class="row-nav">
          <button id="prevBtn" title="å‰ã®æœˆ">â—€</button>
          <select id="monthSelect" title="æœˆ"></select>
          <select id="yearSelect" title="å¹´"></select>
          <button id="todayBtn" class="ghost">ä»Šæ—¥</button>
        </div>
        <div class="row-action">
          <button id="addBtn" class="primary">ï¼‹ äºˆå®šã‚’è¿½åŠ </button>
          <button id="exportPdfBtn" class="primary">PDFã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        </div>
        <div class="row-export">
          <button id="exportBtn" class="ghost">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
          <label class="ghost" style="
          padding:12px 14px; 
          cursor:pointer; 
          border: #aaaaaa 2px solid;
          border-radius:12px; 
          display:inline-flex; 
          align-items:center; 
          min-height:48px;">
            ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
            <input type="file" id="importFile" accept="application/json" hidden>
          </label>
        </div>
        <div class="row-danger">
          <button id="clearBtn" class="warn" title="å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤">å…¨æ¶ˆå»</button>
        </div>
      </div>
    </header>

    <div class="grid">
      <section class="panel">
        <div class="panel-header">
          <div class="legend" id="legend"></div>
          <div class="hint">ã‚¯ãƒªãƒƒã‚¯ã§æ—¥ä»˜ã«äºˆå®šã‚’è¿½åŠ ï¼äºˆå®šã‚’ç·¨é›†</div>
        </div>
        <div id="calendar" class="calendar" aria-label="ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼"></div>
      </section>

      <aside class="panel">
        <div class="panel-header">
          <strong>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</strong>
          <div class="flex">
            <select id="filterCourse">
              <option value="">ã™ã¹ã¦ã®ç§‘ç›®</option>
            </select>
            <select id="filterType">
              <option value="">ã™ã¹ã¦ã®ç¨®é¡</option>
              <option>æ™‚ç¨‹å¤‰æ›´</option>
              <option>èª²é¡Œæå‡ºæ—¥</option>
              <option>è©¦é¨“</option>
              <option>å®šæœŸè©¦é¨“ / å­¦æ ¡æ¨¡è©¦</option>
              <option>æ±é€²æ¨¡è©¦</option>
              <option>éƒ¨æ´»å‹•</option>
              <option>é•·æœŸä¼‘ã¿</option>
              <option>ãã®ä»–</option>
            </select>
          </div>
        </div>
        <div class="panel-body">
          <div class="kpi">
            <div class="card">
              <div class="lbl">ä»Šæœˆã®äºˆå®š</div>
              <div id="kpiTotal" class="num">0</div>
            </div>
            <div class="card">
              <div class="lbl">å…¨ä½“ã®äºˆå®š</div>
              <div id="kpiAll" class="num">0</div>
            </div>
            <div class="card">
              <div class="lbl">è¿‘æ—¥ï¼ˆ7æ—¥ï¼‰</div>
              <div id="kpiSoon" class="num">0</div>
            </div>
          </div>
          <h3>è¿‘æ—¥ã®ç· åˆ‡</h3>
          <div id="upcoming" class="list"></div>
        </div>
      </aside>
    </div>
  </div>

  <dialog id="eventModal">
    <form method="dialog" id="eventForm">
      <div class="modal-head">
        <strong id="modalTitle">äºˆå®šã‚’è¿½åŠ </strong>
        <div class="flex">
          <button type="button" value="cancel" onclick="eventModal.close()">é–‰ã˜ã‚‹</button>
          <button id="deleteBtn" class="danger" type="button" style="display:none">å‰Šé™¤</button>
          <button id="saveBtn" class="primary" type="submit">ä¿å­˜</button>
        </div>
      </div>
      <div class="modal-body">
        <input type="hidden" id="eventId">
        <input type="hidden" id="groupId">
        
        <div id="groupWarning" style="display:none; background:#fff3cd; color:#856404; padding:12px; border-radius:8px; margin-bottom:16px; font-size:13px;"></div>
        
        <div class="row">
          <label>ã‚¿ã‚¤ãƒˆãƒ«
            <input id="title" required placeholder="ä¾‹: è‹±èªèª²é¡Œ Unit5 æå‡º">
          </label>
          <label id="courseLabel">ç§‘ç›®ï¼ˆè‡ªç”±å…¥åŠ›ï¼‰
            <input id="course" list="courseList" placeholder="ä¾‹: è‹±èª">
            <datalist id="courseList"></datalist>
          </label>
        </div>
        <div class="row">
          <label>æ—¥ä»˜
            <input id="date" type="date" required>
          </label>
          <label>
            <input type="checkbox" id="multiDate" style="width:auto; margin-right:8px">
            è¤‡æ•°æ—¥ã«ç™»éŒ²
          </label>
        </div>
        <div class="row">
          <label>é–‹å§‹æ™‚åˆ»ï¼ˆä»»æ„ï¼‰
            <input id="start" type="time" placeholder="ä¾‹: 09:00">
          </label>
          <label>çµ‚äº†æ™‚åˆ»ï¼ˆä»»æ„ï¼‰
            <input id="end" type="time" placeholder="ä¾‹: 17:00">
          </label>
        </div>
        <div class="row" id="endDateRow" style="display:none">
          <label>çµ‚äº†æ—¥ï¼ˆè¤‡æ•°æ—¥ç™»éŒ²æ™‚ï¼‰
            <input id="endDate" type="date">
          </label>
        </div>
        <div class="row">
          <label>ç¨®é¡
            <select id="type">
              <option>æ™‚ç¨‹å¤‰æ›´</option>
              <option>èª²é¡Œæå‡ºæ—¥</option>
              <option>è©¦é¨“</option>
              <option>å®šæœŸè©¦é¨“ / å­¦æ ¡æ¨¡è©¦</option>
              <option>æ±é€²æ¨¡è©¦</option>
              <option>éƒ¨æ´»å‹•</option>
              <option>é•·æœŸä¼‘ã¿</option>
              <option>ãã®ä»–</option>
            </select>
          </label>
        </div>
        <div class="row">
          <label>ãƒ¡ãƒ¢
            <textarea id="notes" rows="3" placeholder="å¿…è¦ãªæŒã¡ç‰©ï¼æå‡ºæ–¹æ³•ãªã©"></textarea>
          </label>
        </div>
        <div class="hint" id="multiDateHint" style="display:none; color:var(--brand); font-weight:600">
          âœ“ è¤‡æ•°æ—¥ã«åŒã˜äºˆå®šã‚’ç™»éŒ²ã—ã¾ã™ï¼ˆé–‹å§‹æ—¥ã€œçµ‚äº†æ—¥ã®å„æ—¥ã«å€‹åˆ¥ã®äºˆå®šã¨ã—ã¦ä½œæˆï¼‰
        </div>
      </div>
    </form>
  </dialog>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    // =====================================
    // Supabase Configuration
    // =====================================
    const SUPABASE_URL = 'https://abfuanjincelcyrlswsp.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFiZnVhbmppbmNlbGN5cmxzd3NwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NjE4MDIsImV4cCI6MjA4MzQzNzgwMn0.OD7371E7A1ZRiqF6SGXnp2JSzPowg2zTt-V36GQ7x9A'
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    // =====================================
    // State Management
    // =====================================
    const state = {
      user: null,
      events: [],
      year: new Date().getFullYear(),
      month: new Date().getMonth(),
      filterCourse: '',
      filterType: '',
      isAuthMode: 'login' // 'login' or 'signup'
    }

    // =====================================
    // Utility Functions
    // =====================================
    const $ = (sel, el = document) => el.querySelector(sel)
    const $$ = (sel, el = document) => Array.from(el.querySelectorAll(sel))

    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36)

    const colorFromCourse = (name) => {
      if (!name) return '#64748b'
      let h = 0
      for (let i = 0; i < name.length; i++) {
        h = (h * 31 + name.charCodeAt(i)) % 360
      }
      return `hsl(${h}, 70%, 50%)`
    }

    const colorFromType = (type) => {
      const typeColors = {
        'æ™‚ç¨‹å¤‰æ›´': '#8a9990',
        'è©¦é¨“': '#e63946',
        'å®šæœŸè©¦é¨“ / å­¦æ ¡æ¨¡è©¦': '#f7a500',
        'æ±é€²æ¨¡è©¦': '#009c88',
        'éƒ¨æ´»å‹•': '#00c3ff',
        'é•·æœŸä¼‘ã¿': '#ff6b9d'
      }
      return typeColors[type] || null
    }

    function formatDate(d) {
      const dt = d instanceof Date ? d : new Date(d)
      return dt.getFullYear() + '-' + String(dt.getMonth() + 1).padStart(2, '0') + '-' + String(dt.getDate()).padStart(2, '0')
    }

    function escapeHtml(s) {
      return (s || '').replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]))
    }

    // =====================================
    // Theme Management
    // =====================================
    const themeToggle = $('#theme-toggle')
    const savedTheme = localStorage.getItem('theme')
    if (savedTheme === 'dark') {
      document.body.classList.add('dark')
    }

    themeToggle.onclick = () => {
      document.body.classList.toggle('dark')
      localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light')
    }

    // =====================================
    // Sync Status Management
    // =====================================
    function updateSyncStatus(status) {
      const syncStatus = $('#syncStatus')
      syncStatus.className = 'sync-status'
      
      if (status === 'synced') {
        syncStatus.classList.add('synced')
        syncStatus.innerHTML = '<span>âœ“</span><span>åŒæœŸæ¸ˆã¿</span>'
      } else if (status === 'syncing') {
        syncStatus.classList.add('syncing')
        syncStatus.innerHTML = '<span class="loading-spinner"></span><span>åŒæœŸä¸­...</span>'
      } else if (status === 'error') {
        syncStatus.classList.add('error')
        syncStatus.innerHTML = '<span>âš </span><span>åŒæœŸã‚¨ãƒ©ãƒ¼</span>'
      }
    }

    // =====================================
    // Authentication
    // =====================================
    const authScreen = $('#authScreen')
    const mainApp = $('#mainApp')
    const authForm = $('#authForm')
    const authError = $('#authError')
    const authToggleBtn = $('#authToggleBtn')
    const authToggleText = $('#authToggleText')
    const authSubmit = $('#authSubmit')
    const logoutBtn = $('#logoutBtn')

    authToggleBtn.onclick = () => {
      state.isAuthMode = state.isAuthMode === 'login' ? 'signup' : 'login'
      if (state.isAuthMode === 'signup') {
        authSubmit.textContent = 'æ–°è¦ç™»éŒ²'
        authToggleText.textContent = 'ã™ã§ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã®å ´åˆ'
        authToggleBtn.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³'
      } else {
        authSubmit.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³'
        authToggleText.textContent = 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ãªã„å ´åˆ'
        authToggleBtn.textContent = 'æ–°è¦ç™»éŒ²'
      }
      authError.style.display = 'none'
    }

    authForm.onsubmit = async (e) => {
      e.preventDefault()
      authError.style.display = 'none'
      authSubmit.disabled = true
      authSubmit.textContent = 'å‡¦ç†ä¸­...'

      const email = $('#authEmail').value
      const password = $('#authPassword').value

      try {
        let result
        if (state.isAuthMode === 'signup') {
          result = await supabase.auth.signUp({ email, password })
          if (result.error) throw result.error
          authError.textContent = 'ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚'
          authError.style.background = '#e0f2e9'
          authError.style.color = '#0d5c2d'
          authError.style.display = 'block'
          authForm.reset()
        } else {
          result = await supabase.auth.signInWithPassword({ email, password })
          if (result.error) throw result.error
        }
      } catch (error) {
        authError.textContent = error.message
        authError.style.display = 'block'
        authSubmit.disabled = false
        authSubmit.textContent = state.isAuthMode === 'login' ? 'ãƒ­ã‚°ã‚¤ãƒ³' : 'æ–°è¦ç™»éŒ²'
      }
    }

    logoutBtn.onclick = async () => {
      if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
        await supabase.auth.signOut()
      }
    }

    supabase.auth.onAuthStateChange((event, session) => {
  if (session) {
    state.user = session.user
    authScreen.style.display = 'none'
    mainApp.classList.add('visible')
    $('#userEmail').textContent = session.user.email
    loadEvents()
    // DOMè¦ç´ ãŒåˆæœŸåŒ–ã•ã‚ŒãŸå¾Œã«å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    setTimeout(() => render(), 100)
  } else {
    state.user = null
    authScreen.style.display = 'flex'
    mainApp.classList.remove('visible')
  }
})

  // Check initial session
const { data: { session } } = await supabase.auth.getSession()
if (session) {
  state.user = session.user
  authScreen.style.display = 'none'
  mainApp.classList.add('visible')
  $('#userEmail').textContent = session.user.email
  await loadEvents()
  // DOMè¦ç´ ãŒåˆæœŸåŒ–ã•ã‚ŒãŸå¾Œã«å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
  setTimeout(() => render(), 100)
}

    // =====================================
    // Supabase Event Management
    // =====================================
    async function loadEvents() {
      try {
        updateSyncStatus('syncing')
        const { data, error } = await supabase
          .from('events')
          .select('*')
          .eq('user_id', state.user.id)
          .order('date', { ascending: true })

        if (error) throw error

        state.events = data || []
        render()
        updateSyncStatus('synced')
      } catch (error) {
        console.error('Error loading events:', error)
        updateSyncStatus('error')
      }
    }

    async function saveEvent(event) {
      try {
        updateSyncStatus('syncing')
        const eventData = {
          ...event,
          user_id: state.user.id
        }

        const { data, error } = await supabase
          .from('events')
          .upsert(eventData)
          .select()

        if (error) throw error

        await loadEvents()
        updateSyncStatus('synced')
        return data
      } catch (error) {
        console.error('Error saving event:', error)
        updateSyncStatus('error')
        throw error
      }
    }

    async function deleteEvent(id) {
      try {
        updateSyncStatus('syncing')
        const { error } = await supabase
          .from('events')
          .delete()
          .eq('id', id)
          .eq('user_id', state.user.id)

        if (error) throw error

        await loadEvents()
        updateSyncStatus('synced')
      } catch (error) {
        console.error('Error deleting event:', error)
        updateSyncStatus('error')
        throw error
      }
    }

    async function deleteEventGroup(groupId) {
      try {
        updateSyncStatus('syncing')
        const { error } = await supabase
          .from('events')
          .delete()
          .eq('group_id', groupId)
          .eq('user_id', state.user.id)

        if (error) throw error

        await loadEvents()
        updateSyncStatus('synced')
      } catch (error) {
        console.error('Error deleting event group:', error)
        updateSyncStatus('error')
        throw error
      }
    }

    async function updateEventGroup(groupId, updates) {
      try {
        updateSyncStatus('syncing')
        const { error } = await supabase
          .from('events')
          .update(updates)
          .eq('group_id', groupId)
          .eq('user_id', state.user.id)

        if (error) throw error

        await loadEvents()
        updateSyncStatus('synced')
      } catch (error) {
        console.error('Error updating event group:', error)
        updateSyncStatus('error')
        throw error
      }
    }

    async function clearAllEvents() {
      try {
        updateSyncStatus('syncing')
        const { error } = await supabase
          .from('events')
          .delete()
          .eq('user_id', state.user.id)

        if (error) throw error

        await loadEvents()
        updateSyncStatus('synced')
      } catch (error) {
        console.error('Error clearing events:', error)
        updateSyncStatus('error')
        throw error
      }
    }

    // Subscribe to realtime changes
    supabase
      .channel('events')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'events' }, (payload) => {
        if (state.user && payload.new?.user_id === state.user.id) {
          loadEvents()
        }
      })
      .subscribe()

    // =====================================
    // Calendar Rendering
    // =====================================
    const monthNames = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ']
    const monthSelect = $('#monthSelect')
    const yearSelect = $('#yearSelect')

    for (let m = 0; m < 12; m++) {
      const opt = document.createElement('option')
      opt.value = m
      opt.textContent = monthNames[m]
      monthSelect.appendChild(opt)
    }

    const thisYear = new Date().getFullYear()
    for (let y = thisYear - 3; y <= thisYear + 3; y++) {
      const opt = document.createElement('option')
      opt.value = y
      opt.textContent = y + 'å¹´'
      yearSelect.appendChild(opt)
    }

    function render() {
  // DOMè¦ç´ ãŒã¾ã åˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
  if (!monthSelect || !yearSelect) {
    return
  }
  
  monthSelect.value = state.month
  yearSelect.value = state.year
  renderLegend()
  renderCalendar()
  renderDashboard()
  fillCourseDatalist()
}

    function getMonthMatrix(y, m) {
      const days = []
      const last = new Date(y, m + 1, 0).getDate()
      for (let d = 1; d <= last; d++) {
        days.push(new Date(y, m, d))
      }
      return days
    }

    function renderCalendar() {
      const cal = $('#calendar')
      cal.innerHTML = ''
      const dows = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥']
      dows.forEach(d => {
        const h = document.createElement('div')
        h.className = 'dow'
        h.textContent = d
        cal.appendChild(h)
      })

      const cells = getMonthMatrix(state.year, state.month)
      const todayStr = formatDate(new Date())

      const filtered = state.events.filter(e =>
        (!state.filterCourse || e.course === state.filterCourse) &&
        (!state.filterType || e.type === state.filterType)
      )

      const counts = {}
      filtered.forEach(e => {
        counts[e.date] = (counts[e.date] || 0) + 1
      })

      cells.forEach(d => {
        const dStr = formatDate(d)
        const inMonth = d.getMonth() === state.month
        const cell = document.createElement('div')
        cell.className = 'cell heat-' + Math.min(4, counts[dStr] || 0)
        if (!inMonth) cell.style.opacity = 0.35
        if (dStr === todayStr) cell.classList.add('today')

        const dateEl = document.createElement('div')
        dateEl.className = 'date'
        dateEl.textContent = `${d.getDate()}`
        cell.appendChild(dateEl)

        filtered
          .filter(e => e.date === dStr && inMonth)
          .sort((a, b) => a.title.localeCompare(b.title))
          .slice(0, 4)
          .forEach(e => {
            const chip = document.createElement('div')
            chip.className = 'chip'
            const timeStr = e.start ? ` ${e.start}` : ''
            chip.title = `${e.title}ï¼ˆ${e.course || 'ç§‘ç›®æœªè¨­å®š'}ï¼‰${timeStr}`
            const typeColor = colorFromType(e.type)
            chip.style.background = typeColor || colorFromCourse(e.course)
            chip.style.color = '#fff'
            chip.textContent = `${timeStr ? timeStr + ' ' : ''}${e.title || 'ç„¡é¡Œ'}`
            chip.onclick = () => openModal(e)
            cell.appendChild(chip)
          })

        cell.onclick = ev => {
          if (ev.target === cell || ev.target === dateEl) openModal({ date: dStr })
        }

        cal.appendChild(cell)
      })
    }

    function renderLegend() {
      const box = $('#legend')
      box.innerHTML = ''
      const courses = [...new Set(state.events.map(e => e.course).filter(Boolean))].sort()
      const fc = $('#filterCourse')
      fc.innerHTML = '<option value="">ã™ã¹ã¦ã®ç§‘ç›®</option>' + courses.map(c => `<option>${c}</option>`).join('')
      courses.forEach(c => {
        const el = document.createElement('span')
        el.className = 'chip'
        el.textContent = c
        el.style.background = colorFromCourse(c)
        el.style.color = '#fff'
        el.onclick = () => {
          state.filterCourse = state.filterCourse === c ? '' : c
          $('#filterCourse').value = state.filterCourse
          render()
        }
        box.appendChild(el)
      })
    }

    function renderDashboard() {
      const now = new Date()
      const monthStart = new Date(state.year, state.month, 1)
      const monthEnd = new Date(state.year, state.month + 1, 0)

      const filtered = state.events.filter(e =>
        (!state.filterCourse || e.course === state.filterCourse) &&
        (!state.filterType || e.type === state.filterType)
      )
      const inMonth = filtered.filter(e => {
        const d = new Date(e.date)
        return d >= monthStart && d <= monthEnd
      })

      $('#kpiTotal').textContent = inMonth.length
      $('#kpiAll').textContent = filtered.length
      $('#kpiSoon').textContent = filtered.filter(e => {
        const d = new Date(e.date)
        const diff = (d - now) / (1000 * 60 * 60 * 24)
        return diff >= 0 && diff <= 7
      }).length

      const upcoming = filtered
        .filter(e => new Date(e.date) >= new Date(now.getFullYear(), now.getMonth(), now.getDate()))
        .sort((a, b) => new Date(a.date) - new Date(b.date))
        .slice(0, 20)

      const box = $('#upcoming')
      box.innerHTML = ''
      if (upcoming.length === 0) {
        box.innerHTML = '<div class="hint">ç›´è¿‘ã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>'
        return
      }
      upcoming.forEach(e => {
        const it = document.createElement('div')
        it.className = 'item'
        const left = document.createElement('div')
        const timeStr = e.start ? ` ${e.start}${e.end ? '-' + e.end : ''}` : ''
        left.innerHTML = `<div><strong>${escapeHtml(e.title || 'ç„¡é¡Œ')}</strong></div>
          <div class="meta">${e.date}${timeStr} ï¼ ${e.course || 'ç§‘ç›®æœªè¨­å®š'} ï¼ ${e.type}</div>
          ${e.notes ? `<div class="hint">${escapeHtml(e.notes)}</div>` : ''}`
        const right = document.createElement('div')
        right.style.display = 'flex'
        right.style.flexDirection = 'column'
        right.style.gap = '6px'
        right.style.alignItems = 'end'
        const edit = document.createElement('button')
        edit.textContent = 'ç·¨é›†'
        edit.onclick = () => openModal(e)
        right.appendChild(edit)
        it.appendChild(left)
        it.appendChild(right)
        box.appendChild(it)
      })
    }

    function fillCourseDatalist() {
      const list = $('#courseList')
      list.innerHTML = ''
      ;[...new Set(state.events.map(e => e.course).filter(Boolean))].sort().forEach(c => {
        const opt = document.createElement('option')
        opt.value = c
        list.appendChild(opt)
      })
    }

    // =====================================
    // Event Modal
    // =====================================
    const eventModal = $('#eventModal')

    function updateCourseVisibility() {
      const type = $('#type').value
      const courseLabel = $('#courseLabel')
      const courseInput = $('#course')
      const noCourseTypes = ['æ™‚ç¨‹å¤‰æ›´', 'è©¦é¨“', 'å®šæœŸè©¦é¨“ / å­¦æ ¡æ¨¡è©¦', 'æ±é€²æ¨¡è©¦', 'éƒ¨æ´»å‹•', 'é•·æœŸä¼‘ã¿']

      if (noCourseTypes.includes(type)) {
        courseInput.disabled = true
        courseInput.style.background = '#e2e8f0'
        courseInput.style.color = '#94a3b8'
        courseLabel.style.opacity = '0.5'
      } else {
        courseInput.disabled = false
        courseInput.style.background = 'var(--panel)'
        courseInput.style.color = 'var(--text)'
        courseLabel.style.opacity = '1'
      }
    }

    function toggleMultiDate() {
      const isMulti = $('#multiDate').checked
      $('#endDateRow').style.display = isMulti ? '' : 'none'
      $('#multiDateHint').style.display = isMulti ? 'block' : 'none'
      if (isMulti) {
        $('#endDate').required = true
      } else {
        $('#endDate').required = false
      }
    }

    function openModal(e = {}) {
      const isGrouped = e.group_id && state.events.filter(ev => ev.group_id === e.group_id).length > 1
      
      $('#modalTitle').textContent = e.id ? 'äºˆå®šã‚’ç·¨é›†' : 'äºˆå®šã‚’è¿½åŠ '
      $('#eventId').value = e.id || ''
      $('#groupId').value = e.group_id || ''
      $('#title').value = e.title || ''
      $('#course').value = e.course || ''
      $('#date').value = e.date || formatDate(new Date(state.year, state.month, 1))
      $('#endDate').value = ''
      $('#multiDate').checked = false
      $('#type').value = e.type || 'èª²é¡Œæå‡ºæ—¥'
      $('#notes').value = e.notes || ''
      
      // ã‚°ãƒ«ãƒ¼ãƒ—ç·¨é›†ã®è­¦å‘Šã‚’è¡¨ç¤º
      if (isGrouped) {
        $('#groupWarning').style.display = 'block'
        const groupEvents = state.events.filter(ev => ev.group_id === e.group_id)
        const dates = groupEvents.map(ev => ev.date).sort()
        $('#groupWarning').innerHTML = `âš ï¸ ã“ã®äºˆå®šã¯${dates[0]}ã€œ${dates[dates.length-1]}ã®${groupEvents.length}æ—¥é–“ã®ã‚°ãƒ«ãƒ¼ãƒ—äºˆå®šã§ã™ã€‚ç·¨é›†ã™ã‚‹ã¨å…¨ã¦ã®æ—¥ä»˜ã«åæ˜ ã•ã‚Œã¾ã™ã€‚`
      } else {
        $('#groupWarning').style.display = 'none'
      }
      
      updateCourseVisibility()
      toggleMultiDate()
      $('#deleteBtn').style.display = e.id ? '' : 'none'
      eventModal.showModal()
      setTimeout(() => $('#title').focus(), 50)
    }

    $('#type').addEventListener('change', updateCourseVisibility)
    $('#multiDate').addEventListener('change', toggleMultiDate)

    $('#eventForm').addEventListener('submit', async (ev) => {
      ev.preventDefault()
      const id = $('#eventId').value || uid()
      const groupId = $('#groupId').value
      const isMulti = $('#multiDate').checked
      const startDate = $('#date').value
      const endDate = $('#endDate').value

      const evObj = {
        title: $('#title').value.trim() || 'ç„¡é¡Œ',
        course: $('#course').value.trim(),
        type: $('#type').value,
        notes: $('#notes').value.trim()
      }

      try {
        if (isMulti && endDate && endDate >= startDate) {
          // è¤‡æ•°æ—¥ç™»éŒ²ï¼ˆæ–°è¦ä½œæˆæ™‚ï¼‰
          const start = new Date(startDate)
          const end = new Date(endDate)
          const newGroupId = uid() // æ–°ã—ã„ã‚°ãƒ«ãƒ¼ãƒ—ID

          // å„æ—¥ä»˜ã”ã¨ã«äºˆå®šã‚’ä½œæˆ
          for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
            const dateStr = formatDate(d)
            const newId = uid()
            await saveEvent({
              ...evObj,
              id: newId,
              group_id: newGroupId,
              date: dateStr
            })
          }
        } else if (groupId && state.events.filter(e => e.group_id === groupId).length > 1) {
          // ã‚°ãƒ«ãƒ¼ãƒ—äºˆå®šã®ç·¨é›†
          await updateEventGroup(groupId, evObj)
        } else {
          // å˜ä¸€æ—¥ç™»éŒ²ã¾ãŸã¯å˜ç‹¬äºˆå®šã®ç·¨é›†
          await saveEvent({
            ...evObj,
            id,
            group_id: groupId || null,
            date: startDate
          })
        }

        eventModal.close()
        render()
      } catch (error) {
        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message)
      }
    })

    $('#deleteBtn').onclick = async () => {
      const id = $('#eventId').value
      const groupId = $('#groupId').value
      if (!id) return
      
      const isGrouped = groupId && state.events.filter(e => e.group_id === groupId).length > 1
      
      if (isGrouped) {
        const groupEvents = state.events.filter(e => e.group_id === groupId)
        if (confirm(`ã“ã®äºˆå®šã¯${groupEvents.length}æ—¥é–“ã®ã‚°ãƒ«ãƒ¼ãƒ—äºˆå®šã§ã™ã€‚å…¨ã¦ã®æ—¥ä»˜ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nå€‹åˆ¥ã®æ—¥ã ã‘å‰Šé™¤ã—ãŸã„å ´åˆã¯ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚`)) {
          try {
            await deleteEventGroup(groupId)
            eventModal.close()
            render()
          } catch (error) {
            alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message)
          }
        } else {
          // å€‹åˆ¥å‰Šé™¤ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æä¾›
          if (confirm('ã“ã®æ—¥ã ã‘å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
            try {
              await deleteEvent(id)
              eventModal.close()
              render()
            } catch (error) {
              alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message)
            }
          }
        }
      } else {
        if (confirm('ã“ã®äºˆå®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
          try {
            await deleteEvent(id)
            eventModal.close()
            render()
          } catch (error) {
            alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message)
          }
        }
      }
    }

    // =====================================
    // Navigation Controls
    // =====================================
    $('#prevBtn').onclick = () => {
      const d = new Date(state.year, state.month - 1, 1)
      state.year = d.getFullYear()
      state.month = d.getMonth()
      render()
    }

    $('#todayBtn').onclick = () => {
      const now = new Date()
      state.year = now.getFullYear()
      state.month = now.getMonth()
      state.filterCourse = ''
      state.filterType = ''
      render()
    }

    monthSelect.onchange = () => {
      state.month = Number(monthSelect.value)
      render()
    }

    yearSelect.onchange = () => {
      state.year = Number(yearSelect.value)
      render()
    }

    $('#filterCourse').onchange = e => {
      state.filterCourse = e.target.value
      render()
    }

    $('#filterType').onchange = e => {
      state.filterType = e.target.value
      render()
    }

    $('#addBtn').onclick = () => openModal({ date: formatDate(new Date(state.year, state.month, 1)) })

    // =====================================
    // Export/Import/Clear
    // =====================================
    $('#exportBtn').onclick = () => {
      const blob = new Blob([JSON.stringify(state.events, null, 2)], { type: 'application/json' })
      const a = document.createElement('a')
      a.href = URL.createObjectURL(blob)
      a.download = 'student-calendar-data.json'
      a.click()
      URL.revokeObjectURL(a.href)
    }

    $('#importFile').onchange = async e => {
      const file = e.target.files[0]
      if (!file) return
      try {
        const text = await file.text()
        const data = JSON.parse(text)
        if (!Array.isArray(data)) throw new Error('JSONå½¢å¼ãŒä¸æ­£ã§ã™')

        for (const ev of data) {
          if (!ev.id) ev.id = uid()
          await saveEvent(ev)
        }

        alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚')
      } catch (err) {
        alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—: ' + err.message)
      }
      e.target.value = ''
    }

    $('#clearBtn').onclick = async () => {
      if (confirm('æœ¬å½“ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
        try {
          await clearAllEvents()
        } catch (error) {
          alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message)
        }
      }
    }

    $('#exportPdfBtn').onclick = () => {
      const element = document.getElementById('calendar')
      const opt = {
        margin: 0.5,
        filename: `ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼_${state.year}_${state.month + 1}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' }
      }
      html2pdf().set(opt).from(element).save()
    }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</body>
</html>

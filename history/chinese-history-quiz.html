<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="../images/chinese-history.svg">
    <title>ä¸­å›½ç‹æœå² å¹´ä»£ã‚¯ã‚¤ã‚º â€” Shoei451</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="chinese-quiz.css">
    
</head>
<body>
    <header>
        <div class="header-content">
            <h1>ğŸ“… ä¸­å›½ç‹æœå² å¹´ä»£å½“ã¦ã‚¯ã‚¤ã‚º</h1>
            <button onclick="window.location.href='index.html'">æ­´å²ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</button>
            <span class="logo-switches">
                <button id="theme-toggle" type="button" title="Toggle Theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
    </header>

    <div class="container">
        <!-- Setup Screen -->
        <div id="setupScreen" class="setup-screen">
            <h2>ã‚¯ã‚¤ã‚ºè¨­å®š</h2>
            
            <div class="form-group">
                <label>å‡ºé¡Œã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
                <div style="margin-bottom: 15px; display: flex; gap: 10px;">
                    <button type="button" onclick="selectAllCategories()" style="padding: 8px 16px; font-size: 0.9rem;">å…¨é¸æŠ</button>
                    <button type="button" onclick="clearAllCategories()" style="padding: 8px 16px; font-size: 0.9rem; background: var(--bg-light-secondary); color: var(--text-light); border: 2px solid var(--border-light);">é¸æŠè§£é™¤</button>
                </div>
                <div class="category-chips" id="categorySelection"></div>
            </div>

            <div class="form-group">
                <label for="questionCount">å‡ºé¡Œæ•°</label>
                <input type="number" id="questionCount" min="5" max="50" value="10">
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button id="startQuizBtn" onclick="startQuiz()">ã‚¯ã‚¤ã‚ºã‚’é–‹å§‹</button>
            </div>
        </div>

        <!-- Quiz Screen -->
        <div id="quizScreen" class="quiz-screen hidden">
            <div class="quiz-question">
                <div class="question-number" id="questionNumber"></div>
                <div id="categoryChip"></div>
                <div class="event-title" id="eventTitle"></div>
                <div class="event-description" id="eventDescription"></div>
            </div>

            <div class="answer-input">
                <label for="yearInput">ã“ã®å‡ºæ¥äº‹ã¯ä½•å¹´ï¼Ÿ</label>
                <input type="text" id="yearInput" placeholder="answer here..." maxlength="6" inputmode="numeric">
                <div style="font-size: 0.85rem; color: var(--text-light-secondary); margin-top: 10px;">
                    ç´€å…ƒå‰ã¯è² ã®æ•°ã§å…¥åŠ›ï¼ˆä¾‹ï¼š-221 = å‰221å¹´ï¼‰
                </div>
            </div>

            <div id="feedback" class="feedback hidden"></div>

            <div class="quiz-controls">
                <button id="submitAnswerBtn" onclick="submitAnswer()">å›ç­”ã™ã‚‹</button>
                <button id="nextQuestionBtn" class="hidden" onclick="nextQuestion()">æ¬¡ã®å•é¡Œ</button>
            </div>
        </div>

        <!-- Result Screen -->
        <div id="resultScreen" class="result-screen hidden">
            <h2>ã‚¯ã‚¤ã‚ºçµæœ</h2>
            
            <div class="score-summary">
                <div class="score-card">
                    <div class="label">æ­£è§£æ•°</div>
                    <div class="number" id="correctCount"></div>
                </div>
                <div class="score-card">
                    <div class="label">ä¸æ­£è§£æ•°</div>
                    <div class="number" id="incorrectCount"></div>
                </div>
                <div class="score-card">
                    <div class="label">æ­£è§£ç‡</div>
                    <div class="number" id="accuracy"></div>
                </div>
            </div>

            <div id="mistakesList" class="mistakes-list"></div>

            <div style="text-align: center; margin-top: 30px;">
                <button onclick="resetQuiz()">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦</button>
            </div>
        </div>

        <div id="loadingScreen" class="loading">
            <p>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://gjuqsyaugrsshmjerhme.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdqdXFzeWF1Z3Jzc2htamVyaG1lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0NzA3NTYsImV4cCI6MjA4MjA0Njc1Nn0.V8q5ddz5tPy7wBaQ73aGtmCZyqzA6pPciPRwRIZjJcs';
        
        const quizApiClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // State
        let events = [];
        let selectedCategories = new Set();
        let quizQuestions = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let currentAnswer = null;

        const categories = ['ç‹æœæˆç«‹', 'ç‹æœæ»…äº¡', 'åä¹±', 'æˆ¦äº‰', 'å¤–äº¤', 'å†…æ”¿', 'çµŒæ¸ˆ', 'æ–‡åŒ–', 'ãã®ä»–'];

        // Theme handling
        (function initTheme() {
            if (localStorage.getItem("pref-theme") === "dark") {
                document.body.classList.add('dark');
            } else if (localStorage.getItem("pref-theme") === "light") {
                document.body.classList.remove('dark');
            } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark');
            }
        })();

        document.addEventListener('DOMContentLoaded', function() {
            const themeToggle = document.getElementById('theme-toggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    document.body.classList.toggle('dark');
                    if (document.body.classList.contains('dark')) {
                        localStorage.setItem('pref-theme', 'dark');
                    } else {
                        localStorage.setItem('pref-theme', 'light');
                    }
                });
            }

            init();
        });

        async function init() {
            await loadEvents();
            renderCategorySelection();
            hideLoading();
        }

        async function loadEvents() {
            try {
                const { data, error } = await quizApiClient
                    .from('chinese_history')
                    .select('*');

                if (error) throw error;
                events = data || [];
            } catch (error) {
                console.error('Error loading events:', error);
                alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
            }
        }

        function renderCategorySelection() {
            const container = document.getElementById('categorySelection');
            container.innerHTML = categories.map(cat => 
                `<div class="category-chip ${cat}" onclick="toggleCategory('${cat}')">${cat}</div>`
            ).join('');
        }

        function toggleCategory(category) {
            if (selectedCategories.has(category)) {
                selectedCategories.delete(category);
            } else {
                selectedCategories.add(category);
            }
            updateCategoryUI();
        }

        function selectAllCategories() {
            categories.forEach(cat => selectedCategories.add(cat));
            updateCategoryUI();
        }

        function clearAllCategories() {
            selectedCategories.clear();
            updateCategoryUI();
        }

        function updateCategoryUI() {
            categories.forEach(cat => {
                const elem = document.querySelector(`.category-chip.${cat}`);
                if (selectedCategories.has(cat)) {
                    elem.classList.add('selected');
                } else {
                    elem.classList.remove('selected');
                }
            });
        }

        function startQuiz() {
            if (selectedCategories.size === 0) {
                alert('å°‘ãªãã¨ã‚‚1ã¤ã®ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const count = parseInt(document.getElementById('questionCount').value);
            if (count < 5 || count > 50) {
                alert('å‡ºé¡Œæ•°ã¯5ã€œ50ã®ç¯„å›²ã§æŒ‡å®šã—ã¦ãã ã•ã„');
                return;
            }

            const filteredEvents = events.filter(e => selectedCategories.has(e.category));
            
            if (filteredEvents.length < count) {
                alert(`é¸æŠã—ãŸã‚«ãƒ†ã‚´ãƒªã«ã¯${filteredEvents.length}å€‹ã®ã‚¤ãƒ™ãƒ³ãƒˆã—ã‹ã‚ã‚Šã¾ã›ã‚“`);
                return;
            }

            quizQuestions = shuffleArray(filteredEvents).slice(0, count);
            currentQuestionIndex = 0;
            userAnswers = [];
            
            showScreen('quiz');
            showQuestion();
        }

        function showQuestion() {
            const question = quizQuestions[currentQuestionIndex];
            
            document.getElementById('questionNumber').textContent = 
                `å•é¡Œ ${currentQuestionIndex + 1} / ${quizQuestions.length}`;
            
            document.getElementById('categoryChip').innerHTML = 
                `<span class="category-chip ${question.category}">${question.category}</span>`;
            
            document.getElementById('eventTitle').textContent = question.title;
            document.getElementById('eventDescription').textContent = question.description || '';
            
            document.getElementById('yearInput').value = '';
            document.getElementById('yearInput').focus();
            document.getElementById('feedback').classList.add('hidden');
            document.getElementById('submitAnswerBtn').classList.remove('hidden');
            document.getElementById('nextQuestionBtn').classList.add('hidden');
            
            currentAnswer = null;
        }

        function submitAnswer() {
            const input = document.getElementById('yearInput').value.trim();
            
            if (!input || !/^-?\d+$/.test(input)) {
                alert('å¹´ã‚’æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆç´€å…ƒå‰ã¯è² ã®æ•°ã§: -221ï¼‰');
                return;
            }

            const userYear = parseInt(input);
            const question = quizQuestions[currentQuestionIndex];
            const correctYear = question.year;
            const isCorrect = userYear === correctYear;

            currentAnswer = {
                question: question,
                userAnswer: userYear,
                correctAnswer: correctYear,
                isCorrect: isCorrect
            };

            userAnswers.push(currentAnswer);

            const feedback = document.getElementById('feedback');
            feedback.classList.remove('hidden', 'correct', 'incorrect');
            
            if (isCorrect) {
                feedback.classList.add('correct');
                feedback.innerHTML = `âœ“ æ­£è§£ï¼<br>${formatYear(correctYear)}`;
            } else {
                feedback.classList.add('incorrect');
                feedback.innerHTML = `Ã— ä¸æ­£è§£<br>ã‚ãªãŸã®å›ç­”: ${formatYear(userYear)}<br>æ­£è§£: ${formatYear(correctYear)}`;
            }

            document.getElementById('submitAnswerBtn').classList.add('hidden');
            document.getElementById('nextQuestionBtn').classList.remove('hidden');
        }

        function formatYear(year) {
            if (year < 0) {
                return `å‰${Math.abs(year)}å¹´`;
            }
            return `${year}å¹´`;
        }

        function nextQuestion() {
            currentQuestionIndex++;
            
            if (currentQuestionIndex >= quizQuestions.length) {
                showResults();
            } else {
                showQuestion();
            }
        }

        function showResults() {
            const correctCount = userAnswers.filter(a => a.isCorrect).length;
            const incorrectCount = userAnswers.length - correctCount;
            const accuracy = Math.round((correctCount / userAnswers.length) * 100);

            document.getElementById('correctCount').textContent = correctCount;
            document.getElementById('incorrectCount').textContent = incorrectCount;
            document.getElementById('accuracy').textContent = accuracy + '%';

            const mistakes = userAnswers.filter(a => !a.isCorrect);
            const mistakesList = document.getElementById('mistakesList');
            
            if (mistakes.length > 0) {
                mistakesList.innerHTML = `
                    <h3 style="color: var(--text-light); margin-bottom: 20px;">é–“é•ãˆãŸå•é¡Œï¼ˆå¾©ç¿’ç”¨ï¼‰</h3>
                    ${mistakes.map(m => `
                        <div class="mistake-item">
                            <div class="mistake-header">
                                <span class="mistake-title">${m.question.title}</span>
                                <span class="category-chip ${m.question.category}">${m.question.category}</span>
                            </div>
                            <div style="color: var(--text-light-secondary); font-size: 0.9rem; margin-top: 5px;">
                                ${m.question.description || ''}
                            </div>
                            <div class="mistake-answers">
                                <span class="your-answer">ã‚ãªãŸã®å›ç­”: ${formatYear(m.userAnswer)}</span>
                                <span class="correct-answer">æ­£è§£: ${formatYear(m.correctAnswer)}</span>
                            </div>
                        </div>
                    `).join('')}
                `;
            } else {
                mistakesList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-light-secondary);">
                        ğŸ‰ å®Œç’§ã§ã™ï¼å…¨å•æ­£è§£ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼
                    </div>
                `;
            }

            showScreen('result');
        }

        function resetQuiz() {
            selectedCategories.clear();
            updateCategoryUI();
            document.getElementById('questionCount').value = 10;
            showScreen('setup');
        }

        function showScreen(screen) {
            document.getElementById('setupScreen').classList.add('hidden');
            document.getElementById('quizScreen').classList.add('hidden');
            document.getElementById('resultScreen').classList.add('hidden');
            document.getElementById('loadingScreen').classList.add('hidden');

            if (screen === 'setup') {
                document.getElementById('setupScreen').classList.remove('hidden');
            } else if (screen === 'quiz') {
                document.getElementById('quizScreen').classList.remove('hidden');
            } else if (screen === 'result') {
                document.getElementById('resultScreen').classList.remove('hidden');
            }
        }

        function hideLoading() {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('setupScreen').classList.remove('hidden');
        }

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // Allow Enter key to submit
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !document.getElementById('quizScreen').classList.contains('hidden')) {
                if (!document.getElementById('submitAnswerBtn').classList.contains('hidden')) {
                    submitAnswer();
                } else if (!document.getElementById('nextQuestionBtn').classList.contains('hidden')) {
                    nextQuestion();
                }
            }
        });
    </script>
</body>
</html>
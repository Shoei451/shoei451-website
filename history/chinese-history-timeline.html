<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="../images/chinese-history.svg">
    <title>ä¸­å›½ç‹æœå²å¹´è¡¨ â€” Shoei451</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="chinese-original.css">
    
</head>
<body>
    <header>
        <div class="header-content">
            <h1>ğŸ“œ ä¸­å›½ç‹æœå²å¹´è¡¨</h1>
            <div class="controls">
                <input type="text" id="searchBox" class="search-box" placeholder="ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¤œç´¢...">
                <button id="addEventBtn">+ ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ </button>
                <!--<button onclick="window.location.href='c-print.html'">å°åˆ·ç”¨ãƒšãƒ¼ã‚¸</button>-->
                <button onclick="window.location.href='index.html'">æ­´å²ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</button>
                <button onclick="window.location.href='chinese-history-quiz.html'">ã‚¯ã‚¤ã‚ºã¯ã“ã¡ã‚‰</button>
                <span class="logo-switches">
                    <button id="theme-toggle" type="button" title="Toggle Theme">
                        <svg id="moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                        <svg id="sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="5"></circle>
                            <line x1="12" y1="1" x2="12" y2="3"></line>
                            <line x1="12" y1="21" x2="12" y2="23"></line>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                            <line x1="1" y1="12" x2="3" y2="12"></line>
                            <line x1="21" y1="12" x2="23" y2="12"></line>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                        </svg>
                    </button>
                </span>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="tabs" id="categoryTabs">
            <button class="tab active" data-category="all">ã™ã¹ã¦</button>
            <button class="tab" data-category="ç‹æœæˆç«‹">ç‹æœæˆç«‹</button>
            <button class="tab" data-category="ç‹æœæ»…äº¡">ç‹æœæ»…äº¡</button>
            <button class="tab" data-category="åä¹±">åä¹±</button>
            <button class="tab" data-category="æˆ¦äº‰">æˆ¦äº‰</button>
            <button class="tab" data-category="å¤–äº¤">å¤–äº¤</button>
            <button class="tab" data-category="å†…æ”¿">å†…æ”¿</button>
            <button class="tab" data-category="çµŒæ¸ˆ">çµŒæ¸ˆ</button>
            <button class="tab" data-category="æ–‡åŒ–">æ–‡åŒ–</button>
            <button class="tab" data-category="ãã®ä»–">ãã®ä»–</button>
        </div>

        <div id="timelineContainer">
            <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
    </div>

    <!-- Modal for Add/Edit Event -->
    <div class="modal" id="eventModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ </h2>
                <button class="close-modal" id="closeModal" type="button">Ã—</button>
            </div>
            <form id="eventForm">
                <input type="hidden" id="eventId">
                
                <div class="form-group">
                    <label for="eventTitle">ã‚¤ãƒ™ãƒ³ãƒˆå *</label>
                    <input type="text" id="eventTitle" required>
                </div>

                <div class="form-group">
                    <label for="eventDateType">æ—¥ä»˜ã®å½¢å¼</label>
                    <select id="eventDateType">
                        <option value="year">å¹´ã®ã¿</option>
                        <option value="full">å®Œå…¨ãªæ—¥ä»˜</option>
                    </select>
                </div>

                <div class="form-group" id="yearOnlyGroup">
                    <label for="eventYear">å¹´</label>
                    <input type="number" id="eventYear" min="-3000" max="2100" placeholder="ä¾‹: 221ï¼ˆç´€å…ƒå‰ã¯è² ã®æ•°ã§: -221ï¼‰">
                </div>

                <div class="form-group" id="fullDateGroup" style="display: none;">
                    <label for="eventDate">æ—¥ä»˜</label>
                    <input type="date" id="eventDate">
                </div>

                <div class="form-group">
                    <label for="eventCategory">ã‚«ãƒ†ã‚´ãƒª *</label>
                    <select id="eventCategory" required>
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="ç‹æœæˆç«‹">ç‹æœæˆç«‹</option>
                        <option value="ç‹æœæ»…äº¡">ç‹æœæ»…äº¡</option>
                        <option value="åä¹±">åä¹±</option>
                        <option value="æˆ¦äº‰">æˆ¦äº‰</option>
                        <option value="å¤–äº¤">å¤–äº¤</option>
                        <option value="å†…æ”¿">å†…æ”¿</option>
                        <option value="çµŒæ¸ˆ">çµŒæ¸ˆ</option>
                        <option value="æ–‡åŒ–">æ–‡åŒ–</option>
                        <option value="ãã®ä»–">ãã®ä»–</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="eventDescription">èª¬æ˜</label>
                    <textarea id="eventDescription"></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-cancel" id="cancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://gjuqsyaugrsshmjerhme.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdqdXFzeWF1Z3Jzc2htamVyaG1lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0NzA3NTYsImV4cCI6MjA4MjA0Njc1Nn0.V8q5ddz5tPy7wBaQ73aGtmCZyqzA6pPciPRwRIZjJcs';
        
        const apiClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // State
        let events = [];
        let currentCategory = 'all';
        let searchQuery = '';

        // Theme handling
        (function initTheme() {
            if (localStorage.getItem("pref-theme") === "dark") {
                document.body.classList.add('dark');
            } else if (localStorage.getItem("pref-theme") === "light") {
                document.body.classList.remove('dark');
            } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark');
            }
        })();

        document.addEventListener('DOMContentLoaded', function() {
            const themeToggle = document.getElementById('theme-toggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    document.body.classList.toggle('dark');
                    if (document.body.classList.contains('dark')) {
                        localStorage.setItem('pref-theme', 'dark');
                    } else {
                        localStorage.setItem('pref-theme', 'light');
                    }
                });
            }

            // Date type switching
            const dateTypeSelect = document.getElementById('eventDateType');
            const yearOnlyGroup = document.getElementById('yearOnlyGroup');
            const fullDateGroup = document.getElementById('fullDateGroup');
            
            dateTypeSelect.addEventListener('change', function() {
                if (this.value === 'year') {
                    yearOnlyGroup.style.display = 'block';
                    fullDateGroup.style.display = 'none';
                } else {
                    yearOnlyGroup.style.display = 'none';
                    fullDateGroup.style.display = 'block';
                }
            });

            init();
        });

        async function init() {
            await loadEvents();
            setupEventListeners();
        }

        async function loadEvents() {
            try {
                const { data, error } = await apiClient
                    .from('chinese_history')
                    .select('*')
                    .order('year', { ascending: true });

                if (error) throw error;
                events = data || [];
                renderTimeline();
            } catch (error) {
                console.error('Error loading events:', error);
                document.getElementById('timelineContainer').innerHTML = `
                    <div class="empty-state">
                        <p>âš ï¸ ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">Supabaseã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„</p>
                    </div>
                `;
            }
        }

        function renderTimeline() {
            const container = document.getElementById('timelineContainer');
            
            const filteredEvents = events.filter(event => {
                const matchesCategory = currentCategory === 'all' || event.category === currentCategory;
                const matchesSearch = !searchQuery || 
                    event.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    (event.description && event.description.toLowerCase().includes(searchQuery.toLowerCase()));
                return matchesCategory && matchesSearch;
            });

            if (filteredEvents.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <p>ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">ã€Œ+ ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>
                    </div>
                `;
                return;
            }

            const tableHTML = `
                <table class="timeline-table">
                    <thead>
                        <tr>
                            <th style="width: 120px;">æ—¥ä»˜</th>
                            <th style="width: 30%;">ã‚¤ãƒ™ãƒ³ãƒˆå</th>
                            <th style="width: 15%;">ã‚«ãƒ†ã‚´ãƒª</th>
                            <th>èª¬æ˜</th>
                            <th style="width: 150px;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredEvents.map(event => `
                            <tr>
                                <td class="event-date">${formatDate(event.year, event.date_type, event.full_date)}</td>
                                <td class="event-title">${escapeHtml(event.title)}</td>
                                <td><span class="category-chip ${escapeHtml(event.category)}">${escapeHtml(event.category)}</span></td>
                                <td class="event-description">${escapeHtml(event.description || '')}</td>
                                <td class="event-actions">
                                    <button class="btn-edit" onclick="editEvent(${event.id})">ç·¨é›†</button>
                                    <button class="btn-delete" onclick="deleteEvent(${event.id})">å‰Šé™¤</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHTML;
        }

        function formatDate(year, dateType, fullDate) {
            if (dateType === 'full' && fullDate) {
                const date = new Date(fullDate);
                const y = date.getFullYear();
                const m = String(date.getMonth() + 1).padStart(2, '0');
                const d = String(date.getDate()).padStart(2, '0');
                if (y < 0) {
                    return `å‰${Math.abs(y)}/${m}/${d}`;
                }
                return `${y}/${m}/${d}`;
            }
            
            // Year only
            if (year < 0) {
                return `å‰${Math.abs(year)}å¹´`;
            }
            return `${year}å¹´`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function setupEventListeners() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');
                    currentCategory = e.target.dataset.category;
                    renderTimeline();
                });
            });

            document.getElementById('searchBox').addEventListener('input', (e) => {
                searchQuery = e.target.value;
                renderTimeline();
            });

            document.getElementById('addEventBtn').addEventListener('click', openAddModal);
            document.getElementById('closeModal').addEventListener('click', closeModal);
            document.getElementById('cancelBtn').addEventListener('click', closeModal);
            document.getElementById('eventForm').addEventListener('submit', handleFormSubmit);
            
            document.getElementById('eventModal').addEventListener('click', (e) => {
                if (e.target.id === 'eventModal') closeModal();
            });
        }

        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ ';
            document.getElementById('eventForm').reset();
            document.getElementById('eventId').value = '';
            document.getElementById('eventDateType').value = 'year';
            document.getElementById('yearOnlyGroup').style.display = 'block';
            document.getElementById('fullDateGroup').style.display = 'none';
            document.getElementById('eventModal').classList.add('active');
        }

        function editEvent(id) {
            const event = events.find(e => e.id === id);
            if (!event) return;

            document.getElementById('modalTitle').textContent = 'ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç·¨é›†';
            document.getElementById('eventId').value = event.id;
            document.getElementById('eventTitle').value = event.title;
            document.getElementById('eventCategory').value = event.category;
            document.getElementById('eventDescription').value = event.description || '';
            
            // Handle date type
            if (event.date_type === 'full' && event.full_date) {
                document.getElementById('eventDateType').value = 'full';
                document.getElementById('eventDate').value = event.full_date;
                document.getElementById('yearOnlyGroup').style.display = 'none';
                document.getElementById('fullDateGroup').style.display = 'block';
            } else {
                document.getElementById('eventDateType').value = 'year';
                document.getElementById('eventYear').value = event.year;
                document.getElementById('yearOnlyGroup').style.display = 'block';
                document.getElementById('fullDateGroup').style.display = 'none';
            }
            
            document.getElementById('eventModal').classList.add('active');
        }

        async function deleteEvent(id) {
            if (!confirm('ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹?')) return;

            try {
                const { error } = await apiClient
                    .from('chinese_history')
                    .delete()
                    .eq('id', id);

                if (error) throw error;
                await loadEvents();
            } catch (error) {
                console.error('Error deleting event:', error);
                alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        function closeModal() {
            document.getElementById('eventModal').classList.remove('active');
        }

        async function handleFormSubmit(e) {
            e.preventDefault();

            const dateType = document.getElementById('eventDateType').value;
            let yearValue;
            let fullDateValue = null;
            
            if (dateType === 'year') {
                const year = document.getElementById('eventYear').value;
                if (!year) {
                    alert('å¹´ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }
                yearValue = parseInt(year);
            } else {
                const fullDate = document.getElementById('eventDate').value;
                if (!fullDate) {
                    alert('æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }
                fullDateValue = fullDate;
                yearValue = new Date(fullDate).getFullYear();
            }

            const eventData = {
                title: document.getElementById('eventTitle').value,
                year: yearValue,
                date_type: dateType,
                full_date: fullDateValue,
                category: document.getElementById('eventCategory').value,
                description: document.getElementById('eventDescription').value
            };

            const eventId = document.getElementById('eventId').value;

            try {
                if (eventId) {
                    const { error } = await apiClient
                        .from('chinese_history')
                        .update(eventData)
                        .eq('id', eventId);

                    if (error) throw error;
                } else {
                    const { error } = await apiClient
                        .from('chinese_history')
                        .insert([eventData]);

                    if (error) throw error;
                }

                closeModal();
                await loadEvents();
            } catch (error) {
                console.error('Error saving event:', error);
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸­å›½ç‹æœæ–‡åŒ–å²ã‚¯ã‚¤ã‚º</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700;900&family=Noto+Sans+SC:wght@400;500;700&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Noto Sans SC', sans-serif;
    }
    
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #fffbeb 0%, #fef2f2 50%, #fff7ed 100%);
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .animate-fadeIn {
      animation: fadeIn 0.6s ease-out;
    }
    
    .animate-slideUp-1 {
      animation: slideUp 0.6s ease-out 0.1s both;
    }
    
    .animate-slideUp-2 {
      animation: slideUp 0.6s ease-out 0.2s both;
    }
    
    .animate-slideUp-3 {
      animation: slideUp 0.6s ease-out 0.3s both;
    }
    
    .animate-slideUp-4 {
      animation: slideUp 0.6s ease-out 0.4s both;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    .pattern-bg {
      background-image: 
        radial-gradient(circle at 20% 50%, rgba(217, 119, 6, 0.03) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(153, 27, 27, 0.03) 0%, transparent 50%);
    }
    
    .title-chinese {
      font-family: 'Noto Serif SC', serif;
      font-weight: 900;
      font-size: 3.75rem;
      background: linear-gradient(135deg, #991b1b 0%, #dc2626 50%, #b91c1c 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 1rem;
    }
    
    .seal-stamp {
      position: relative;
      display: inline-block;
      padding: 0.5rem 1rem;
      color: #991b1b;
      border: 3px solid #991b1b;
      transform: rotate(-2deg);
      box-shadow: 2px 2px 0 rgba(153, 27, 27, 0.2);
      font-size: 1.5rem;
      font-weight: bold;
    }
    
    .seal-stamp::before {
      content: '';
      position: absolute;
      top: -3px;
      left: -3px;
      right: -3px;
      bottom: -3px;
      border: 1px solid #991b1b;
    }
    
    .quiz-card {
      background: linear-gradient(135deg, #ffffff 0%, #fef3c7 100%);
      border: 2px solid #d97706;
      border-radius: 12px;
      padding: 2rem;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .quiz-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, transparent 0%, rgba(217, 119, 6, 0.1) 100%);
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .quiz-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(153, 27, 27, 0.2);
    }
    
    .quiz-card:hover::before {
      opacity: 1;
    }
    
    .quiz-card h3 {
      font-size: 1.5rem;
      font-weight: bold;
      color: #7c2d12;
      margin-bottom: 0.75rem;
      position: relative;
      z-index: 1;
    }
    
    .quiz-card p {
      color: #374151;
      margin-bottom: 1rem;
      position: relative;
      z-index: 1;
    }
    
    .quiz-card .meta {
      color: #b45309;
      font-weight: 500;
      position: relative;
      z-index: 1;
    }
    
    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1.5rem;
    }
    
    .quiz-container {
      max-width: 48rem;
      margin: 0 auto;
    }
    
    .quiz-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      color: #6b7280;
    }
    
    .score {
      color: #7c2d12;
      font-weight: bold;
      font-size: 1.25rem;
    }
    
    .quiz-box {
      background: white;
      border-radius: 1rem;
      padding: 2rem;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      border: 2px solid #fde68a;
    }
    
    .question-title {
      font-family: 'Noto Serif SC', serif;
      font-size: 2.5rem;
      color: #7c2d12;
      text-align: center;
      margin-bottom: 0.5rem;
    }
    
    .question-subtitle {
      color: #6b7280;
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .options-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .option-btn {
      background: white;
      border: 2px solid #fde68a;
      border-radius: 0.75rem;
      padding: 1.5rem;
      font-size: 1.25rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }
    
    .option-btn:hover:not(:disabled) {
      background: #fffbeb;
      transform: scale(1.05);
    }
    
    .option-btn.selected {
      background: #fef3c7;
      border-color: #d97706;
    }
    
    .option-btn.correct {
      background: #dcfce7;
      border-color: #16a34a;
    }
    
    .option-btn.incorrect {
      background: #fee2e2;
      border-color: #dc2626;
    }
    
    .option-btn.missed {
      background: #dbeafe;
      border-color: #2563eb;
    }
    
    .option-btn:disabled {
      cursor: not-allowed;
    }
    
    .icon {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      font-size: 1.5rem;
    }
    
    .icon.check {
      color: #16a34a;
    }
    
    .icon.x {
      color: #dc2626;
    }
    
    .icon.info {
      color: #2563eb;
    }
    
    .submit-btn, .next-btn, .menu-btn, .retry-btn {
      width: 100%;
      background: #7c2d12;
      color: white;
      padding: 1rem;
      border-radius: 0.75rem;
      font-weight: bold;
      font-size: 1.125rem;
      border: none;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    
    .submit-btn:hover, .next-btn:hover, .menu-btn:hover, .retry-btn:hover {
      background: #991b1b;
    }
    
    .submit-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .retry-btn {
      background: #d97706;
    }
    
    .retry-btn:hover {
      background: #b45309;
    }
    
    .matching-container {
      max-width: 80rem;
      margin: 0 auto;
    }
    
    .matching-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 2rem;
    }
    
    .matching-column h3 {
      font-size: 1.25rem;
      font-weight: bold;
      color: #7c2d12;
      margin-bottom: 1rem;
    }
    
    .matching-items {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .matching-btn {
      width: 100%;
      padding: 1rem;
      border-radius: 0.75rem;
      border: 2px solid #fde68a;
      background: white;
      font-size: 1.125rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .matching-btn:hover:not(:disabled) {
      background: #fffbeb;
      transform: scale(1.05);
    }
    
    .matching-btn.selected {
      background: #fef3c7;
      border-color: #d97706;
      transform: scale(1.05);
    }
    
    .matching-btn:disabled {
      background: #f3f4f6;
      border-color: #d1d5db;
      color: #9ca3af;
      cursor: not-allowed;
    }
    
    .grouping-container {
      max-width: 90rem;
      margin: 0 auto;
    }
    
    .ungrouped-area {
      background: white;
      border: 2px dashed #fde68a;
      border-radius: 0.75rem;
      padding: 1rem;
      min-height: 80px;
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }
    
    .ungrouped-title {
      font-size: 1.25rem;
      font-weight: bold;
      color: #7c2d12;
      margin-bottom: 1rem;
    }
    
    .draggable-item {
      background: #fef3c7;
      border: 2px solid #d97706;
      border-radius: 0.5rem;
      padding: 0.5rem 1rem;
      cursor: move;
      transition: all 0.2s;
      user-select: none;
    }
    
    .draggable-item:hover {
      background: #fde68a;
    }
    
    .draggable-item.dragging {
      opacity: 0.5;
    }
    
    .categories-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
    }
    
    .category-box {
      background: white;
      border: 2px solid #fde68a;
      border-radius: 0.75rem;
      padding: 1rem;
      min-height: 200px;
    }
    
    .category-box.drag-over {
      background: #fffbeb;
      border-color: #d97706;
    }
    
    .category-title {
      font-size: 1.125rem;
      font-weight: bold;
      color: #7c2d12;
      margin-bottom: 0.75rem;
    }
    
    .category-items {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .grouped-item {
      border-radius: 0.5rem;
      padding: 0.5rem 0.75rem;
    }
    
    .grouped-item.correct {
      background: #dcfce7;
      border: 2px solid #16a34a;
    }
    
    .grouped-item.incorrect {
      background: #fee2e2;
      border: 2px solid #dc2626;
    }
    
    .results-box {
      max-width: 32rem;
      width: 100%;
      background: white;
      border-radius: 1rem;
      padding: 3rem;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      border: 2px solid #fde68a;
      text-align: center;
    }
    
    .results-title {
      font-family: 'Noto Serif SC', serif;
      font-size: 3rem;
      color: #7c2d12;
      margin-bottom: 1.5rem;
    }
    
    .results-score {
      font-size: 4.5rem;
      font-weight: bold;
      color: #b45309;
      margin: 3rem 0 1rem;
    }
    
    .results-percentage {
      font-size: 1.875rem;
      color: #6b7280;
      margin-bottom: 3rem;
    }
    
    .results-buttons {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .hidden {
      display: none !important;
    }
    
    .text-center {
      text-align: center;
    }
    
    .mb-6 {
      margin-bottom: 1.5rem;
    }
    
    .mb-3 {
      margin-bottom: 0.75rem;
    }
    
    @media (max-width: 768px) {
      .grid-2, .options-grid, .matching-grid, .categories-grid {
        grid-template-columns: 1fr;
      }
      
      .title-chinese {
        font-size: 2.5rem;
      }
      
      .container {
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
  <div id="app" class="container"></div>

  <script>
    // ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿
    const quizData = [
      { name: "æç™½", dynasty: "å”", works: ["é™å¤œæ€", "æ—©ç™ºç™½å¸åŸ", "å°†é€²é…’"], category: "è©©äºº" },
      { name: "æœç”«", dynasty: "å”", works: ["æ˜¥æœ›", "èŒ…å±‹ç‚ºç§‹é¢¨æ‰€ç ´æ­Œ"], category: "è©©äºº" },
      { name: "ç™½å±…æ˜“", dynasty: "å”", works: ["é•·æ¨æ­Œ", "çµç¶è¡Œ"], category: "è©©äºº" },
      { name: "ç‹ç¾²ä¹‹", dynasty: "æ±æ™‹", works: ["è˜­äº­åº"], category: "æ›¸å®¶" },
      { name: "é¡”çœŸå¿", dynasty: "å”", works: ["ç¥­å§ªæ–‡ç¨¿"], category: "æ›¸å®¶" },
      { name: "å¸é¦¬é·", dynasty: "å‰æ¼¢", works: ["å²è¨˜"], category: "æ­´å²å®¶" },
      { name: "ç­å›º", dynasty: "å¾Œæ¼¢", works: ["æ¼¢æ›¸"], category: "æ­´å²å®¶" },
      { name: "è˜‡è»¾", dynasty: "å®‹", works: ["èµ¤å£è³¦", "å¿µå¥´å¬Œ"], category: "è©©äºº" },
      { name: "ææ¸…ç…§", dynasty: "å®‹", works: ["å£°å£°æ…¢", "å¦‚å¤¢ä»¤"], category: "è©©äºº" },
      { name: "é–¢æ¼¢å¿", dynasty: "å…ƒ", works: ["ç«‡å¨¥å†¤"], category: "åŠ‡ä½œå®¶" },
      { name: "æ›¹é›ªèŠ¹", dynasty: "æ¸…", works: ["ç´…æ¥¼å¤¢"], category: "å°èª¬å®¶" },
      { name: "å‘‰æ‰¿æ©", dynasty: "æ˜", works: ["è¥¿éŠè¨˜"], category: "å°èª¬å®¶" }
    ];

    const dynasties = ["å‰æ¼¢", "å¾Œæ¼¢", "æ±æ™‹", "å”", "å®‹", "å…ƒ", "æ˜", "æ¸…"];
    const categories = ["è©©äºº", "æ›¸å®¶", "æ­´å²å®¶", "åŠ‡ä½œå®¶", "å°èª¬å®¶"];

    // ã‚¢ãƒ—ãƒªã®çŠ¶æ…‹
    let state = {
      mode: 'menu',
      previousMode: null,
      currentQuestion: 0,
      score: 0,
      quizQuestions: [],
      selectedAnswer: null,
      showResult: false,
      multiSelectAnswers: new Set(),
      matchingData: null,
      selectedMatch: null,
      groupingData: null,
      draggedItem: null
    };

    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
    function shuffle(array) {
      return [...array].sort(() => Math.random() - 0.5);
    }

    function resetState() {
      state.currentQuestion = 0;
      state.score = 0;
      state.quizQuestions = [];
      state.selectedAnswer = null;
      state.showResult = false;
      state.multiSelectAnswers = new Set();
      state.matchingData = null;
      state.selectedMatch = null;
      state.groupingData = null;
    }

    // ã‚¯ã‚¤ã‚ºç”Ÿæˆé–¢æ•°
    function generatePersonToDynastyQuiz() {
      const shuffled = shuffle(quizData);
      state.quizQuestions = shuffled.slice(0, 10).map(person => {
        const wrongDynasties = dynasties
          .filter(d => d !== person.dynasty)
          .sort(() => Math.random() - 0.5)
          .slice(0, 3);
        const options = shuffle([...wrongDynasties, person.dynasty]);
        
        return {
          question: person.name,
          options,
          correct: person.dynasty,
          type: 'single'
        };
      });
    }

    function generateDynastyToPeopleQuiz() {
      const questions = dynasties.map(dynasty => {
        const correctPeople = quizData.filter(p => p.dynasty === dynasty);
        const wrongPeople = quizData
          .filter(p => p.dynasty !== dynasty)
          .sort(() => Math.random() - 0.5)
          .slice(0, 4);
        const options = shuffle([...correctPeople, ...wrongPeople]).map(p => p.name);
        
        return {
          question: dynasty,
          options,
          correct: correctPeople.map(p => p.name),
          type: 'multiple'
        };
      });
      
      state.quizQuestions = shuffle(questions).slice(0, 5);
    }

    function generateMatchingQuiz() {
      const shuffled = shuffle(quizData.filter(p => p.works.length > 0)).slice(0, 6);
      
      const people = shuffled.map(p => ({ id: p.name, text: p.name, type: 'person' }));
      const works = shuffle(shuffled.map(p => ({ id: p.name, text: p.works[0], type: 'work' })));
      
      state.matchingData = {
        people,
        works,
        matched: [],
        correctMatches: shuffled.map(p => ({ person: p.name, work: p.works[0] }))
      };
    }

    function generateGroupingQuiz() {
      const items = shuffle(quizData).slice(0, 12);
      const groups = {};
      categories.forEach(cat => groups[cat] = []);
      
      state.groupingData = {
        ungrouped: items.map(p => ({ name: p.name, category: p.category })),
        groups,
        categories
      };
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
    function startQuiz(quizMode) {
      resetState();
      state.mode = quizMode;
      state.previousMode = quizMode;
      
      if (quizMode === 'person-to-dynasty') {
        generatePersonToDynastyQuiz();
      } else if (quizMode === 'dynasty-to-people') {
        generateDynastyToPeopleQuiz();
      } else if (quizMode === 'matching') {
        generateMatchingQuiz();
      } else if (quizMode === 'grouping') {
        generateGroupingQuiz();
      }
      
      render();
    }

    function handleAnswer(answer) {
      if (state.showResult) return;
      
      state.selectedAnswer = answer;
      state.showResult = true;
      
      const current = state.quizQuestions[state.currentQuestion];
      if (current.type === 'single' && answer === current.correct) {
        state.score++;
      }
      
      render();
    }

    function handleMultiSelect(answer) {
      if (state.multiSelectAnswers.has(answer)) {
        state.multiSelectAnswers.delete(answer);
      } else {
        state.multiSelectAnswers.add(answer);
      }
      render();
    }

    function submitMultiSelect() {
      if (state.showResult) return;
      
      state.showResult = true;
      const current = state.quizQuestions[state.currentQuestion];
      const correctSet = new Set(current.correct);
      
      if (state.multiSelectAnswers.size === correctSet.size &&
          [...state.multiSelectAnswers].every(a => correctSet.has(a))) {
        state.score++;
      }
      
      render();
    }

    function nextQuestion() {
      if (state.currentQuestion < state.quizQuestions.length - 1) {
        state.currentQuestion++;
        state.selectedAnswer = null;
        state.showResult = false;
        state.multiSelectAnswers = new Set();
      } else {
        state.mode = 'results';
      }
      render();
    }

    function handleMatching(item) {
      if (!state.selectedMatch) {
        state.selectedMatch = item;
      } else {
        if (state.selectedMatch.type !== item.type) {
          const person = state.selectedMatch.type === 'person' ? state.selectedMatch : item;
          const work = state.selectedMatch.type === 'work' ? state.selectedMatch : item;
          
          const isCorrect = state.matchingData.correctMatches.some(
            m => m.person === person.id && m.work === work.text
          );
          
          if (isCorrect) {
            state.matchingData.matched.push({ person: person.id, work: work.text });
            state.score++;
          }
        }
        state.selectedMatch = null;
      }
      render();
    }

    function handleDragStart(item) {
      state.draggedItem = item;
      event.target.classList.add('dragging');
    }

    function handleDragEnd(event) {
      event.target.classList.remove('dragging');
    }

    function handleDragOver(event) {
      event.preventDefault();
      event.currentTarget.classList.add('drag-over');
    }

    function handleDragLeave(event) {
      event.currentTarget.classList.remove('drag-over');
    }

    function handleDrop(category, event) {
      event.preventDefault();
      event.currentTarget.classList.remove('drag-over');
      
      if (!state.draggedItem) return;
      
      // Remove from ungrouped
      state.groupingData.ungrouped = state.groupingData.ungrouped.filter(
        i => i.name !== state.draggedItem.name
      );
      
      // Remove from other groups
      Object.keys(state.groupingData.groups).forEach(cat => {
        state.groupingData.groups[cat] = state.groupingData.groups[cat].filter(
          i => i.name !== state.draggedItem.name
        );
      });
      
      // Add to new group
      state.groupingData.groups[category].push(state.draggedItem);
      
      if (state.draggedItem.category === category) {
        state.score++;
      }
      
      state.draggedItem = null;
      render();
    }

    function resetToMenu() {
      state.mode = 'menu';
      render();
    }

    // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–¢æ•°
    function renderMenu() {
      return `
        <div class="pattern-bg">
          <div class="text-center mb-6 animate-fadeIn">
            <h1 class="title-chinese">ä¸­å›½ç‹æœæ–‡åŒ–å²</h1>
            <div class="seal-stamp">
              ã‚¯ã‚¤ã‚º
            </div>
            <p style="margin-top: 1.5rem; color: #6b7280; font-size: 1.125rem;">
              å­¦ç¿’å½¢å¼ã‚’é¸æŠã—ã¦ãã ã•ã„
            </p>
          </div>
          
          <div class="grid-2">
            <div class="quiz-card animate-slideUp-1" onclick="startQuiz('person-to-dynasty')">
              <h3>äººç‰©â†’ç‹æœ</h3>
              <p>äººç‰©åã‹ã‚‰æ´»èºã—ãŸç‹æœã‚’é¸æŠ</p>
              <div class="meta">4æŠå•é¡Œ â€¢ 10å•</div>
            </div>
            
            <div class="quiz-card animate-slideUp-2" onclick="startQuiz('dynasty-to-people')">
              <h3>ç‹æœâ†’äººç‰©</h3>
              <p>ç‹æœã«è©²å½“ã™ã‚‹äººç‰©ã‚’å…¨ã¦é¸æŠ</p>
              <div class="meta">è¤‡æ•°é¸æŠ â€¢ 5å•</div>
            </div>
            
            <div class="quiz-card animate-slideUp-3" onclick="startQuiz('matching')">
              <h3>äººç‰©ã¨ä½œå“</h3>
              <p>äººç‰©åã¨ä»£è¡¨ä½œå“ã‚’ãƒãƒƒãƒãƒ³ã‚°</p>
              <div class="meta">ãƒãƒƒãƒãƒ³ã‚° â€¢ 6çµ„</div>
            </div>
            
            <div class="quiz-card animate-slideUp-4" onclick="startQuiz('grouping')">
              <h3>ã‚«ãƒ†ã‚´ãƒªåˆ†é¡</h3>
              <p>äººç‰©ã‚’ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°</p>
              <div class="meta">ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— â€¢ 12äºº</div>
            </div>
          </div>
        </div>
      `;
    }

    function renderQuiz() {
      const current = state.quizQuestions[state.currentQuestion];
      const isMultiple = current.type === 'multiple';
      
      let optionsHtml = '';
      current.options.forEach((option, idx) => {
        const isSelected = isMultiple 
          ? state.multiSelectAnswers.has(option)
          : state.selectedAnswer === option;
        const isCorrect = isMultiple
          ? current.correct.includes(option)
          : option === current.correct;
        
        let className = 'option-btn';
        let iconHtml = '';
        
        if (state.showResult) {
          if (isMultiple) {
            if (isCorrect && state.multiSelectAnswers.has(option)) {
              className += ' correct';
              iconHtml = '<span class="icon check">âœ“</span>';
            } else if (isCorrect && !state.multiSelectAnswers.has(option)) {
              className += ' missed';
              iconHtml = '<span class="icon info">âœ“</span>';
            } else if (!isCorrect && state.multiSelectAnswers.has(option)) {
              className += ' incorrect';
              iconHtml = '<span class="icon x">âœ—</span>';
            }
          } else {
            if (option === current.correct) {
              className += ' correct';
              iconHtml = '<span class="icon check">âœ“</span>';
            } else if (isSelected) {
              className += ' incorrect';
              iconHtml = '<span class="icon x">âœ—</span>';
            }
          }
        } else if (isSelected) {
          className += ' selected';
        }
        
        const onClick = isMultiple 
          ? `handleMultiSelect('${option}')`
          : `handleAnswer('${option}')`;
        const disabled = state.showResult && !isMultiple ? 'disabled' : '';
        
        optionsHtml += `
          <button class="${className}" onclick="${onClick}" ${disabled}>
            ${option}
            ${iconHtml}
          </button>
        `;
      });
      
      let actionButton = '';
      if (isMultiple && !state.showResult) {
        const disabled = state.multiSelectAnswers.size === 0 ? 'disabled' : '';
        actionButton = `<button class="submit-btn" onclick="submitMultiSelect()" ${disabled}>è§£ç­”ã‚’ç¢ºå®š</button>`;
      } else if (state.showResult) {
        const text = state.currentQuestion < state.quizQuestions.length - 1 ? 'æ¬¡ã®å•é¡Œ' : 'çµæœã‚’è¦‹ã‚‹';
        actionButton = `<button class="next-btn" onclick="nextQuestion()">${text} â†’</button>`;
      }
      
      return `
        <div class="quiz-container">
          <div class="quiz-header">
            <div>å•é¡Œ ${state.currentQuestion + 1} / ${state.quizQuestions.length}</div>
            <div class="score">æ­£è§£: ${state.score}</div>
          </div>
          
          <div class="quiz-box">
            <h2 class="question-title">${current.question}</h2>
            <p class="question-subtitle">
              ${isMultiple ? 'è©²å½“ã™ã‚‹äººç‰©ã‚’å…¨ã¦é¸æŠã—ã¦ãã ã•ã„' : 'ã“ã®äººç‰©ãŒæ´»èºã—ãŸç‹æœã¯ï¼Ÿ'}
            </p>
            
            <div class="options-grid">
              ${optionsHtml}
            </div>
            
            ${actionButton}
          </div>
        </div>
      `;
    }

    function renderMatching() {
      const isMatched = (id, type) => {
        return state.matchingData.matched.some(m => 
          type === 'person' ? m.person === id : m.work === id
        );
      };
      
      const isSelected = (id) => state.selectedMatch?.id === id;
      
      let peopleHtml = '';
      state.matchingData.people.forEach(person => {
        const matched = isMatched(person.id, 'person');
        const selected = isSelected(person.id);
        const className = matched ? 'matching-btn' : selected ? 'matching-btn selected' : 'matching-btn';
        const disabled = matched ? 'disabled' : '';
        
        peopleHtml += `
          <button class="${className}" onclick='handleMatching(${JSON.stringify(person)})' ${disabled}>
            ${person.text}
          </button>
        `;
      });
      
      let worksHtml = '';
      state.matchingData.works.forEach(work => {
        const matched = isMatched(work.text, 'work');
        const selected = isSelected(work.id);
        const className = matched ? 'matching-btn' : selected ? 'matching-btn selected' : 'matching-btn';
        const disabled = matched ? 'disabled' : '';
        
        worksHtml += `
          <button class="${className}" onclick='handleMatching(${JSON.stringify(work)})' ${disabled}>
            ${work.text}
          </button>
        `;
      });
      
      const allMatched = state.matchingData.matched.length === state.matchingData.people.length;
      
      return `
        <div class="matching-container">
          <div class="text-center mb-6">
            <h2 class="question-title">äººç‰©ã¨ä½œå“ã®ãƒãƒƒãƒãƒ³ã‚°</h2>
            <p class="question-subtitle">äººç‰©ã¨ä½œå“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦çµ„ã¿åˆã‚ã›ã¦ãã ã•ã„</p>
            <div style="margin-top: 1rem; font-size: 1.25rem; font-weight: bold; color: #b45309;">
              æ­£è§£: ${state.score} / ${state.matchingData.people.length}
            </div>
          </div>
          
          <div class="matching-grid">
            <div class="matching-column">
              <h3>äººç‰©</h3>
              <div class="matching-items">
                ${peopleHtml}
              </div>
            </div>
            
            <div class="matching-column">
              <h3>ä½œå“</h3>
              <div class="matching-items">
                ${worksHtml}
              </div>
            </div>
          </div>
          
          ${allMatched ? '<button class="menu-btn" onclick="resetToMenu()" style="margin-top: 2rem;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹ â†»</button>' : ''}
        </div>
      `;
    }

    function renderGrouping() {
      let ungroupedHtml = '';
      state.groupingData.ungrouped.forEach((item, idx) => {
        ungroupedHtml += `
          <div class="draggable-item" draggable="true" 
               ondragstart="handleDragStart(${JSON.stringify(item).replace(/"/g, '&quot;')})"
               ondragend="handleDragEnd(event)">
            ${item.name}
          </div>
        `;
      });
      
      let categoriesHtml = '';
      state.groupingData.categories.forEach(category => {
        let itemsHtml = '';
        state.groupingData.groups[category].forEach(item => {
          const className = item.category === category ? 'grouped-item correct' : 'grouped-item incorrect';
          itemsHtml += `<div class="${className}">${item.name}</div>`;
        });
        
        categoriesHtml += `
          <div class="category-box" 
               ondragover="handleDragOver(event)"
               ondragleave="handleDragLeave(event)"
               ondrop="handleDrop('${category}', event)">
            <div class="category-title">${category}</div>
            <div class="category-items">
              ${itemsHtml}
            </div>
          </div>
        `;
      });
      
      const allGrouped = state.groupingData.ungrouped.length === 0;
      
      return `
        <div class="grouping-container">
          <div class="text-center mb-6">
            <h2 class="question-title">ã‚«ãƒ†ã‚´ãƒªåˆ†é¡</h2>
            <p class="question-subtitle">äººç‰©ã‚’é©åˆ‡ãªã‚«ãƒ†ã‚´ãƒªã«ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ãã ã•ã„</p>
            <div style="margin-top: 1rem; font-size: 1.25rem; font-weight: bold; color: #b45309;">
              æ­£è§£: ${state.score}
            </div>
          </div>
          
          <div class="mb-6">
            <div class="ungrouped-title">æœªåˆ†é¡</div>
            <div class="ungrouped-area">
              ${ungroupedHtml}
            </div>
          </div>
          
          <div class="categories-grid">
            ${categoriesHtml}
          </div>
          
          ${allGrouped ? '<button class="menu-btn" onclick="resetToMenu()" style="margin-top: 2rem;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹ â†»</button>' : ''}
        </div>
      `;
    }

    function renderResults() {
      const percentage = Math.round((state.score / state.quizQuestions.length) * 100);
      
      return `
        <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center;">
          <div class="results-box">
            <h2 class="results-title">çµæœ</h2>
            
            <div class="results-score">
              ${state.score} / ${state.quizQuestions.length}
            </div>
            <div class="results-percentage">
              æ­£ç­”ç‡: ${percentage}%
            </div>
            
            <div class="results-buttons">
              <button class="menu-btn" onclick="resetToMenu()">
                â†» ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹
              </button>
              
              <button class="retry-btn" onclick="startQuiz('${state.previousMode}')">
                ğŸ”„ ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function render() {
      const app = document.getElementById('app');
      
      let content = '';
      if (state.mode === 'menu') {
        content = renderMenu();
      } else if (state.mode === 'person-to-dynasty' || state.mode === 'dynasty-to-people') {
        content = renderQuiz();
      } else if (state.mode === 'matching') {
        content = renderMatching();
      } else if (state.mode === 'grouping') {
        content = renderGrouping();
      } else if (state.mode === 'results') {
        content = renderResults();
      }
      
      app.innerHTML = content;
    }

    // åˆæœŸãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    render();
  </script>
</body>
</html>

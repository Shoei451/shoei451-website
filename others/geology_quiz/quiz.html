<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ã‚¯ã‚¤ã‚ºï½œåœ°è³ªå¹´ä»£ã‚¯ã‚¤ã‚º</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@300;400;600;700&family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet" />
  <script src="data.js"></script>
  <style>
    /* â”€â”€â”€ Reset & Base â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { font-size: 16px; }

    body {
      min-height: 100vh;
      background:
        repeating-linear-gradient(180deg,
          transparent 0, transparent 79px,
          rgba(140,90,30,.05) 79px, rgba(140,90,30,.05) 81px),
        linear-gradient(180deg, #0a0604 0%, #1a0f08 50%, #0e0b06 100%);
      font-family: 'Noto Serif JP', Georgia, serif;
      color: #e8d5b0;
    }

    /* â”€â”€â”€ Scrollbar â”€â”€â”€ */
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: #0a0604; }
    ::-webkit-scrollbar-thumb { background: #6a4a20; border-radius: 3px; }

    /* â”€â”€â”€ Header â”€â”€â”€ */
    .header {
      position: sticky; top: 0; z-index: 100;
      background: rgba(0,0,0,.6);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(200,160,60,.2);
      padding: 12px 20px;
      display: flex; align-items: center; gap: 16px;
    }
    .header-btn {
      background: rgba(200,160,60,.1);
      border: 1px solid rgba(200,160,60,.35);
      color: #c8a040; border-radius: 8px;
      padding: 7px 14px; font-size: 13px;
      cursor: pointer; font-family: inherit;
      transition: background .2s;
      text-decoration: none; display: inline-block;
    }
    .header-btn:hover { background: rgba(200,160,60,.22); }
    .header-btn.blue {
      background: rgba(74,144,208,.1);
      border-color: rgba(74,144,208,.35);
      color: #6ab0e8;
    }
    .header-btn.blue:hover { background: rgba(74,144,208,.22); }

    .progress-wrap { flex: 1; min-width: 0; }
    .progress-label {
      display: flex; justify-content: space-between;
      font-size: 12px; color: #7a6040; margin-bottom: 6px;
    }
    .progress-label span.gold { color: #c8a040; font-weight: 700; }
    .progress-label span.green { color: #60cc90; font-weight: 700; }
    .progress-bar-bg {
      height: 4px; background: rgba(255,255,255,.08);
      border-radius: 2px; overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%; border-radius: 2px;
      background: linear-gradient(90deg, #c8a040, #e8c870);
      transition: width .5s ease;
    }

    /* â”€â”€â”€ Main Quiz Area â”€â”€â”€ */
    .quiz-main {
      max-width: 640px; margin: 0 auto;
      padding: 28px 16px 0;
    }

    /* Question chip */
    .q-chip {
      display: inline-block;
      padding: 4px 14px; border-radius: 20px;
      background: rgba(200,160,60,.1);
      border: 1px solid rgba(200,160,60,.3);
      font-size: 12px; color: #c8a040;
      letter-spacing: .12em; margin-bottom: 20px;
    }

    /* Organism card */
    .org-card {
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(200,160,60,.2);
      border-radius: 16px;
      padding: 28px 24px;
      text-align: center;
      animation: fadeUp .45s ease both;
    }
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(14px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .org-image-wrap {
      width: 180px; height: 180px;
      margin: 0 auto 20px;
      border-radius: 12px;
      background: rgba(0,0,0,.45);
      border: 1px solid rgba(200,160,60,.18);
      display: flex; align-items: center; justify-content: center;
      overflow: hidden;
      animation: float 4s ease-in-out infinite;
    }
    @keyframes float {
      0%,100% { transform: translateY(0) rotate(0deg); }
      50%      { transform: translateY(-7px) rotate(1deg); }
    }
    .org-image-wrap img {
      width: 100%; height: 100%; object-fit: cover;
      border-radius: 12px;
    }
    .org-emoji-fallback {
      font-size: 72px; line-height: 1;
    }

    .org-name {
      font-size: clamp(20px, 5vw, 26px);
      font-weight: 700; color: #e8d0a0;
      margin-bottom: 6px;
    }
    .org-name-en {
      font-size: 13px; color: #6a5830;
      font-style: italic; margin-bottom: 10px;
    }
    .index-badge {
      display: inline-block;
      padding: 2px 10px; border-radius: 10px;
      background: rgba(200,160,60,.18);
      border: 1px solid rgba(200,160,60,.45);
      font-size: 11px; color: #c8a040;
      letter-spacing: .08em; margin-bottom: 12px;
    }
    .org-hint {
      font-size: 13px; color: #a09070;
      line-height: 1.85; max-width: 420px; margin: 0 auto;
    }

    /* Feedback box */
    .feedback-box {
      margin-top: 18px; padding: 16px 18px;
      border-radius: 12px;
      animation: fadeUp .4s ease both;
      text-align: left;
    }
    .feedback-box.correct {
      background: rgba(0,200,100,.08);
      border: 1px solid rgba(0,200,100,.35);
    }
    .feedback-box.wrong {
      background: rgba(220,60,0,.08);
      border: 1px solid rgba(220,60,0,.35);
    }
    .feedback-title {
      font-size: 17px; font-weight: 700; margin-bottom: 6px;
    }
    .feedback-box.correct .feedback-title { color: #60cc90; }
    .feedback-box.wrong .feedback-title   { color: #ff7050; }
    .feedback-correct-label {
      font-size: 13px; color: #e8c870; font-weight: 600;
      margin-bottom: 4px;
    }
    .feedback-hint { font-size: 12px; color: #a09070; line-height: 1.75; }

    /* Next button */
    .next-btn-wrap { text-align: center; margin: 18px 0 8px; }
    .next-btn {
      padding: 12px 44px;
      background: linear-gradient(135deg, #c8a040, #e8c870);
      border: none; border-radius: 24px;
      font-size: 15px; font-weight: 700;
      color: #1a0f00; cursor: pointer;
      font-family: inherit; letter-spacing: .08em;
      box-shadow: 0 4px 20px rgba(200,160,60,.4);
      transition: transform .15s, box-shadow .15s;
    }
    .next-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 28px rgba(200,160,60,.5); }

    /* â”€â”€â”€ Open Drawer Button â”€â”€â”€ */
    .open-drawer-btn {
      display: block; width: 100%;
      margin-top: 20px;
      padding: 14px;
      background: linear-gradient(135deg, rgba(200,160,60,.18), rgba(200,160,60,.1));
      border: 1px solid rgba(200,160,60,.45);
      border-radius: 12px;
      color: #e8c870; font-family: inherit;
      font-size: 15px; font-weight: 700;
      letter-spacing: .1em; cursor: pointer;
      transition: all .2s;
      animation: pulseGlow 2.5s ease-in-out infinite;
    }
    .open-drawer-btn:hover {
      background: linear-gradient(135deg, rgba(200,160,60,.32), rgba(200,160,60,.2));
      transform: translateY(-2px);
      box-shadow: 0 6px 24px rgba(200,160,60,.25);
      animation: none;
    }
    @keyframes pulseGlow {
      0%,100% { box-shadow: 0 0 0 rgba(200,160,60,0); }
      50%      { box-shadow: 0 0 18px rgba(200,160,60,.22); }
    }

    /* â”€â”€â”€ Drawer Overlay â”€â”€â”€ */
    .drawer-overlay {
      display: none;
      position: fixed; inset: 0; z-index: 140;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(3px);
      opacity: 0;
      transition: opacity .3s ease;
    }
    .drawer-overlay.visible {
      display: block;
    }
    .drawer-overlay.open {
      opacity: 1;
    }

    /* â”€â”€â”€ Answer Drawer â”€â”€â”€ */
    .answer-drawer {
      position: fixed; top: 0; left: 0; bottom: 0;
      z-index: 150;
      width: min(340px, 88vw);
      background: rgba(10,6,4,.97);
      backdrop-filter: blur(16px);
      border-right: 1px solid rgba(200,160,60,.25);
      box-shadow: 6px 0 40px rgba(0,0,0,.7);
      transform: translateX(-100%);
      transition: transform .32s cubic-bezier(.4,0,.2,1);
      display: flex; flex-direction: column;
      overflow: hidden;
    }
    .answer-drawer.open {
      transform: translateX(0);
    }

    /* Drawer header */
    .drawer-header {
      padding: 16px 18px 12px;
      border-bottom: 1px solid rgba(200,160,60,.15);
      display: flex; align-items: center; justify-content: space-between;
      flex-shrink: 0;
    }
    .drawer-header-title {
      font-size: 13px; color: #c8a040;
      letter-spacing: .12em; font-weight: 600;
    }
    .drawer-close-btn {
      width: 30px; height: 30px;
      background: rgba(200,160,60,.1);
      border: 1px solid rgba(200,160,60,.3);
      border-radius: 6px; color: #c8a040;
      font-size: 16px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: background .18s; flex-shrink: 0;
    }
    .drawer-close-btn:hover { background: rgba(200,160,60,.22); }

    /* Drawer body */
    .drawer-body {
      flex: 1; overflow-y: auto;
      padding: 14px 16px 24px;
    }
    .drawer-body::-webkit-scrollbar { width: 4px; }
    .drawer-body::-webkit-scrollbar-thumb { background: #6a4a20; border-radius: 2px; }

    .answer-instruction {
      font-size: 10px; color: #6a5830;
      letter-spacing: .18em; margin-bottom: 14px;
      text-align: center;
    }

    /* Era group block */
    .era-group {
      margin-bottom: 10px;
    }
    .era-group-label {
      font-size: 10px; font-weight: 700;
      letter-spacing: .18em; text-transform: uppercase;
      padding: 3px 10px 3px 8px;
      border-left: 3px solid;
      margin-bottom: 6px;
    }
    .era-group.precambrian .era-group-label { color: #ffd090; border-color: #9b5320; }
    .era-group.paleozoic   .era-group-label { color: #90ffd0; border-color: #1d8e62; }
    .era-group.mesozoic    .era-group-label { color: #90c8ff; border-color: #2a6aca; }
    .era-group.cenozoic    .era-group-label { color: #ffb870; border-color: #ca6510; }

    .period-buttons {
      display: flex; flex-wrap: wrap; gap: 6px;
    }

    .period-btn {
      flex: 1 1 auto;
      min-width: 80px;
      padding: 8px 6px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,.12);
      font-size: clamp(11px, 2.5vw, 13px);
      font-family: inherit; font-weight: 600;
      cursor: pointer; text-align: center;
      transition: all .18s ease;
      line-height: 1.3;
    }
    /* per-era colors */
    .era-group.precambrian .period-btn {
      background: rgba(155,83,32,.28); color: #ffd090;
    }
    .era-group.precambrian .period-btn:hover:not(:disabled) {
      background: rgba(155,83,32,.55); transform: scale(1.04);
    }
    .era-group.paleozoic .period-btn {
      background: rgba(29,142,98,.25); color: #90ffd0;
    }
    .era-group.paleozoic .period-btn:hover:not(:disabled) {
      background: rgba(29,142,98,.5); transform: scale(1.04);
    }
    .era-group.mesozoic .period-btn {
      background: rgba(42,106,202,.25); color: #90c8ff;
    }
    .era-group.mesozoic .period-btn:hover:not(:disabled) {
      background: rgba(42,106,202,.5); transform: scale(1.04);
    }
    .era-group.cenozoic .period-btn {
      background: rgba(202,101,16,.25); color: #ffb870;
    }
    .era-group.cenozoic .period-btn:hover:not(:disabled) {
      background: rgba(202,101,16,.5); transform: scale(1.04);
    }

    .period-btn:disabled { cursor: default; }
    .period-btn.state-correct {
      background: rgba(0,200,100,.35) !important;
      border-color: rgba(0,200,100,.7) !important;
      color: #90ffb8 !important;
      box-shadow: 0 0 10px rgba(0,200,100,.25);
    }
    .period-btn.state-wrong {
      background: rgba(220,60,0,.35) !important;
      border-color: rgba(220,60,0,.7) !important;
      color: #ff9070 !important;
    }
    .period-btn.state-dim {
      opacity: .28;
    }

    /* â”€â”€â”€ Results Screen â”€â”€â”€ */
    #results-screen { display: none; }
    .results-wrap {
      max-width: 680px; margin: 0 auto;
      padding: 36px 16px 60px;
    }
    .results-title {
      text-align: center;
      font-family: 'Cinzel', serif;
      font-size: clamp(22px, 5vw, 30px);
      margin-bottom: 8px;
    }
    .score-ring-wrap {
      width: 150px; height: 150px;
      margin: 24px auto;
      position: relative;
    }
    .score-ring-wrap svg { transform: rotate(-90deg); }
    .score-ring-inner {
      position: absolute; inset: 0;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
    }
    .score-num {
      font-family: 'Cinzel', serif;
      font-size: 38px; font-weight: 700; line-height: 1;
    }
    .score-denom { font-size: 14px; color: #6a5830; }
    .score-pct { font-size: 16px; color: #a09070; text-align: center; margin-bottom: 32px; }
    .score-pct strong { font-size: 22px; font-weight: 700; }

    /* Era breakdown */
    .era-breakdown {
      display: flex; flex-wrap: wrap; gap: 12px;
      justify-content: center; margin-bottom: 36px;
    }
    .era-score-card {
      padding: 14px 18px; border-radius: 10px;
      text-align: center; min-width: 110px;
    }
    .era-score-label { font-size: 12px; font-weight: 700; margin-bottom: 8px; }
    .era-score-num { font-size: 24px; font-weight: 700; }
    .era-score-num span { font-size: 14px; opacity: .6; }

    /* History list */
    .history-title {
      font-size: 13px; color: #8a7050;
      letter-spacing: .18em; text-align: center;
      margin-bottom: 14px; text-transform: uppercase;
    }
    .history-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 40px; }
    .history-item {
      display: flex; align-items: center; gap: 14px;
      padding: 12px 14px; border-radius: 10px;
    }
    .history-item.correct {
      background: rgba(0,200,100,.06);
      border: 1px solid rgba(0,200,100,.2);
    }
    .history-item.wrong {
      background: rgba(220,60,0,.06);
      border: 1px solid rgba(220,60,0,.2);
    }
    .history-icon {
      width: 26px; height: 26px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 13px; flex-shrink: 0;
    }
    .history-item.correct .history-icon { background: rgba(0,200,100,.2); color: #60cc90; }
    .history-item.wrong   .history-icon { background: rgba(220,60,0,.2);  color: #ff7050; }
    .history-emoji { font-size: 32px; flex-shrink: 0; }
    .history-body { flex: 1; min-width: 0; }
    .history-name { font-size: 14px; font-weight: 700; }
    .history-item.correct .history-name { color: #90d0a0; }
    .history-item.wrong   .history-name { color: #e09080; }
    .history-answer { font-size: 11px; color: #6a5830; margin-top: 3px; }
    .history-answer .wrong-ans { color: #e09080; }
    .history-index-badge {
      flex-shrink: 0;
      padding: 2px 8px; border-radius: 8px;
      background: rgba(200,160,60,.15);
      border: 1px solid rgba(200,160,60,.3);
      font-size: 9px; color: #c8a040;
    }

    /* Result action buttons */
    .result-actions {
      display: flex; gap: 14px; justify-content: center; flex-wrap: wrap;
    }
    .result-btn {
      padding: 12px 30px; border-radius: 24px;
      font-size: 14px; font-weight: 700;
      font-family: inherit; cursor: pointer;
      letter-spacing: .06em; transition: all .18s;
    }
    .result-btn.primary {
      background: linear-gradient(135deg, #c8a040, #e8c870);
      border: none; color: #1a0f00;
      box-shadow: 0 4px 20px rgba(200,160,60,.4);
    }
    .result-btn.primary:hover { transform: translateY(-2px); }
    .result-btn.secondary {
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(200,160,60,.3);
      color: #c8a040;
    }
    .result-btn.secondary:hover { background: rgba(200,160,60,.1); }

    /* â”€â”€â”€ Flash overlay â”€â”€â”€ */
    .flash-overlay {
      pointer-events: none;
      position: fixed; inset: 0; z-index: 200;
      opacity: 0; transition: opacity .15s;
    }
    .flash-overlay.correct-flash { background: rgba(0,200,100,.14); }
    .flash-overlay.wrong-flash   { background: rgba(220,60,0,.14); }

    /* â”€â”€â”€ Responsive â”€â”€â”€ */
    @media (max-width: 480px) {
      .org-image-wrap { width: 150px; height: 150px; }
      .period-btn { min-width: 68px; font-size: 11px; padding: 7px 4px; }
      .header { padding: 10px 12px; gap: 10px; }
      .quiz-main { padding: 20px 14px 0; }
      .answer-drawer { width: 92vw; }
    }
  </style>
</head>
<body>

<div class="flash-overlay" id="flashOverlay"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     QUIZ SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="quiz-screen">

  <!-- Header -->
  <header class="header">
    <a href="index.html" class="header-btn">â† ãƒ›ãƒ¼ãƒ </a>

    <div class="progress-wrap">
      <div class="progress-label">
        <span>å•é¡Œ <span class="gold" id="qCurrent">1</span> / <span id="qTotal">15</span></span>
        <span>æ­£è§£ <span class="green" id="qScore">0</span> / <span id="qAnswered">0</span></span>
      </div>
      <div class="progress-bar-bg">
        <div class="progress-bar-fill" id="progressBar" style="width:0%"></div>
      </div>
    </div>

    <a href="timeline.html" class="header-btn blue">å¹´è¡¨ â†’</a>
  </header>

  <!-- Quiz body -->
  <div class="quiz-main" id="quizMain">
    <div style="text-align:center">
      <span class="q-chip">ã“ã®ç”Ÿç‰©ãŒä¸»ã«æ´»èºã—ãŸæ™‚ä»£ã¯ã©ã‚Œï¼Ÿ</span>
    </div>

    <!-- Organism card -->
    <div class="org-card" id="orgCard">
      <div class="org-image-wrap" id="orgImageWrap">
        <img id="orgImg" src="" alt="" onerror="this.style.display='none'; document.getElementById('orgEmoji').style.display='block';" />
        <div class="org-emoji-fallback" id="orgEmoji" style="display:none"></div>
      </div>
      <div class="org-name" id="orgName"></div>
      <div class="org-name-en" id="orgNameEn"></div>
      <div id="indexBadgeWrap"></div>
      <p class="org-hint" id="orgHint"></p>
      <div id="feedbackBox"></div>

      <!-- Open drawer button (shown only when not yet answered) -->
      <button class="open-drawer-btn" id="openDrawerBtn" onclick="openDrawer()">
        ğŸ—“ï¸ã€€å¹´ä»£ã‚’é¸ã¶ã€€â†’
      </button>

      <div class="next-btn-wrap" id="nextBtnWrap" style="display:none">
        <button class="next-btn" id="nextBtn">æ¬¡ã®å•é¡Œ â†’</button>
      </div>
    </div>
  </div><!-- .quiz-main -->

</div><!-- #quiz-screen -->

<!-- â”€â”€ Drawer Overlay â”€â”€ -->
<div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>

<!-- â”€â”€ Answer Drawer â”€â”€ -->
<div class="answer-drawer" id="answerDrawer">
  <div class="drawer-header">
    <div class="drawer-header-title">ğŸ—“ï¸ã€€å¹´ä»£ã‚’é¸æŠ</div>
    <button class="drawer-close-btn" onclick="closeDrawer()">âœ•</button>
  </div>
  <div class="drawer-body">
    <div class="answer-instruction" id="answerInstruction">â”€â”€â”€ æ™‚ä»£ã‚’é¸ã‚“ã§ãã ã•ã„ â”€â”€â”€</div>
    <div id="answerButtons"></div>
  </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     RESULTS SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="results-screen">
  <div class="results-wrap">
    <div style="text-align:center; margin-bottom:4px; font-size:52px" id="resultsIcon">ğŸ†</div>
    <div class="results-title" id="resultsTitle" style="color:#e8c870"></div>
    <div class="score-ring-wrap">
      <svg width="150" height="150" viewBox="0 0 150 150">
        <circle cx="75" cy="75" r="62" fill="none" stroke="rgba(255,255,255,.07)" stroke-width="11"/>
        <circle id="scoreRingArc" cx="75" cy="75" r="62" fill="none"
                stroke="#e8c870" stroke-width="11" stroke-linecap="round"
                stroke-dasharray="0 390" style="transition: stroke-dasharray 1.2s ease;"/>
      </svg>
      <div class="score-ring-inner">
        <div class="score-num" id="scoreBig" style="color:#e8c870"></div>
        <div class="score-denom" id="scoreDenom"></div>
      </div>
    </div>
    <div class="score-pct" id="scorePct"></div>

    <!-- Era breakdown -->
    <div style="font-size:13px;color:#8a7050;letter-spacing:.18em;text-align:center;margin-bottom:14px;text-transform:uppercase;">â”€â”€ æ™‚ä»£åˆ¥ã‚¹ã‚³ã‚¢ â”€â”€</div>
    <div class="era-breakdown" id="eraBreakdown"></div>

    <!-- History -->
    <div class="history-title">â”€â”€ è§£ç­”ä¸€è¦§ â”€â”€</div>
    <div class="history-list" id="historyList"></div>

    <!-- Actions -->
    <div class="result-actions">
      <button class="result-btn primary" onclick="restartQuiz()">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦</button>
      <a href="timeline.html" class="result-btn secondary">å¹´è¡¨ã§å¾©ç¿’</a>
    </div>
  </div>
</div>


<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Drawer
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openDrawer() {
  const overlay = document.getElementById('drawerOverlay');
  const drawer  = document.getElementById('answerDrawer');
  overlay.classList.add('visible');
  // Trigger reflow for transition
  void overlay.offsetWidth;
  overlay.classList.add('open');
  drawer.classList.add('open');
  // Scroll drawer body to top
  drawer.querySelector('.drawer-body').scrollTop = 0;
}

function closeDrawer() {
  const overlay = document.getElementById('drawerOverlay');
  const drawer  = document.getElementById('answerDrawer');
  overlay.classList.remove('open');
  drawer.classList.remove('open');
  setTimeout(() => overlay.classList.remove('visible'), 320);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Quiz State
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let quizList = [];
let current = 0;
let score = 0;
let answered = false;
let history = [];

function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function init() {
  quizList = shuffle(ORGANISMS);
  current = 0; score = 0; answered = false; history = [];
  document.getElementById('quiz-screen').style.display = '';
  document.getElementById('results-screen').style.display = 'none';
  renderQuestion();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Render one question
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderQuestion() {
  answered = false;
  const org = quizList[current];
  const total = quizList.length;

  // Progress
  document.getElementById('qCurrent').textContent = current + 1;
  document.getElementById('qTotal').textContent = total;
  document.getElementById('qScore').textContent = score;
  document.getElementById('qAnswered').textContent = current;
  document.getElementById('progressBar').style.width = (current / total * 100) + '%';

  // Organism card â€” re-trigger animation
  const card = document.getElementById('orgCard');
  card.style.animation = 'none';
  void card.offsetWidth;
  card.style.animation = '';

  // Image
  const img = document.getElementById('orgImg');
  const emoji = document.getElementById('orgEmoji');
  img.style.display = '';
  emoji.style.display = 'none';
  img.src = getImagePath(org.id);
  img.alt = org.name;
  emoji.textContent = org.emoji;

  // Text
  document.getElementById('orgName').textContent = org.name;
  document.getElementById('orgNameEn').textContent = org.nameEn;
  document.getElementById('orgHint').textContent = org.hint;

  // Index fossil badge
  const badgeWrap = document.getElementById('indexBadgeWrap');
  badgeWrap.innerHTML = org.isIndexFossil
    ? '<span class="index-badge">ç¤ºæº–åŒ–çŸ³</span>'
    : '';

  // Clear feedback & next
  document.getElementById('feedbackBox').innerHTML = '';
  document.getElementById('nextBtnWrap').style.display = 'none';
  document.getElementById('answerInstruction').textContent = 'â”€â”€â”€ æ™‚ä»£ã‚’é¸ã‚“ã§ãã ã•ã„ â”€â”€â”€';

  // Show "open drawer" button, hide next btn
  const openBtn = document.getElementById('openDrawerBtn');
  if (openBtn) { openBtn.style.display = ''; }

  // Render answer buttons (fresh, not answered)
  renderAnswerButtons(null, null);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Render answer button groups
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAnswerButtons(selectedId, correctId) {
  const container = document.getElementById('answerButtons');
  container.innerHTML = '';

  ERA_GROUPS.forEach(group => {
    const div = document.createElement('div');
    div.className = 'era-group ' + group.id;

    const label = document.createElement('div');
    label.className = 'era-group-label';
    label.textContent = group.name;
    div.appendChild(label);

    const btnRow = document.createElement('div');
    btnRow.className = 'period-buttons';

    group.periods.forEach(pid => {
      const period = getPeriodById(pid);
      if (!period) return;

      const btn = document.createElement('button');
      btn.className = 'period-btn';
      btn.dataset.periodId = pid;
      btn.textContent = period.name;

      if (selectedId !== null) {
        // Show result state
        btn.disabled = true;
        if (pid === correctId) {
          btn.classList.add('state-correct');
        } else if (pid === selectedId && pid !== correctId) {
          btn.classList.add('state-wrong');
        } else {
          btn.classList.add('state-dim');
        }
      } else {
        btn.addEventListener('click', () => handleAnswer(pid));
      }

      btnRow.appendChild(btn);
    });

    div.appendChild(btnRow);
    container.appendChild(div);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Handle answer selection
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleAnswer(selectedPeriodId) {
  if (answered) return;
  answered = true;

  const org = quizList[current];
  const correct = selectedPeriodId === org.correctPeriod;

  if (correct) score++;
  history.push({ org, correct, selected: selectedPeriodId });

  // Flash
  const flashOv = document.getElementById('flashOverlay');
  flashOv.className = 'flash-overlay ' + (correct ? 'correct-flash' : 'wrong-flash');
  flashOv.style.opacity = '1';
  setTimeout(() => { flashOv.style.opacity = '0'; flashOv.className = 'flash-overlay'; }, 600);

  // Close drawer after brief delay so user sees result state in buttons
  setTimeout(() => closeDrawer(), 600);

  // Update answer buttons
  renderAnswerButtons(selectedPeriodId, org.correctPeriod);

  // Feedback box
  const correctPeriod = getPeriodById(org.correctPeriod);
  const fb = document.getElementById('feedbackBox');
  fb.innerHTML = `
    <div class="feedback-box ${correct ? 'correct' : 'wrong'}">
      <div class="feedback-title">${correct ? 'âœ“ã€€æ­£è§£ï¼' : 'âœ—ã€€ä¸æ­£è§£'}</div>
      <div class="feedback-correct-label">æ­£è§£ï¼š${correctPeriod ? correctPeriod.name : ''}ï¼ˆ${org.periodLabel}ï¼‰</div>
      <div class="feedback-hint">${org.description.slice(0, 100)}â€¦</div>
    </div>
  `;

  // Update progress
  document.getElementById('qScore').textContent = score;
  document.getElementById('qAnswered').textContent = current + 1;
  document.getElementById('progressBar').style.width = ((current + 1) / quizList.length * 100) + '%';

  // Instruction + Next button
  document.getElementById('answerInstruction').textContent = 'â”€â”€â”€ ç¢ºèªå¾Œã€æ¬¡ã®å•é¡Œã¸ â”€â”€â”€';
  const nextWrap = document.getElementById('nextBtnWrap');
  const nextBtn = document.getElementById('nextBtn');
  // Hide "year select" button, show "next" button
  const openBtn = document.getElementById('openDrawerBtn');
  if (openBtn) openBtn.style.display = 'none';
  nextWrap.style.display = '';
  const isLast = current + 1 >= quizList.length;
  nextBtn.textContent = isLast ? 'çµæœã‚’è¦‹ã‚‹ â†’' : 'æ¬¡ã®å•é¡Œ â†’';
  nextBtn.onclick = isLast ? showResults : nextQuestion;
}

function nextQuestion() {
  current++;
  renderQuestion();
  // Scroll org card into view
  document.getElementById('orgCard').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Results
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showResults() {
  document.getElementById('quiz-screen').style.display = 'none';
  const rs = document.getElementById('results-screen');
  rs.style.display = '';

  const total = quizList.length;
  const pct = Math.round(score / total * 100);

  const grade = pct >= 90 ? { label: 'åœ°è³ªåšå£«ï¼', icon: 'ğŸ†', color: '#e8c870' }
              : pct >= 70 ? { label: 'ã‚ˆãã§ãã¾ã—ãŸ', icon: 'ğŸŒŸ', color: '#90d0a0' }
              : pct >= 50 ? { label: 'ã¾ãšã¾ãšã§ã™', icon: 'ğŸ“š', color: '#90b0e0' }
              :             { label: 'ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ï¼', icon: 'ğŸ¦´', color: '#e09080' };

  document.getElementById('resultsIcon').textContent = grade.icon;
  document.getElementById('resultsTitle').textContent = grade.label;
  document.getElementById('resultsTitle').style.color = grade.color;
  document.getElementById('scoreBig').textContent = score;
  document.getElementById('scoreBig').style.color = grade.color;
  document.getElementById('scoreDenom').textContent = '/ ' + total;
  document.getElementById('scorePct').innerHTML = `æ­£è§£ç‡ <strong style="color:${grade.color}">${pct}%</strong>`;

  // Ring animation
  const circ = 2 * Math.PI * 62;
  const arc = document.getElementById('scoreRingArc');
  arc.style.stroke = grade.color;
  setTimeout(() => {
    arc.style.strokeDasharray = `${circ * pct / 100} ${circ}`;
  }, 100);

  // Era breakdown
  const eb = document.getElementById('eraBreakdown');
  eb.innerHTML = '';
  ERA_GROUPS.forEach(group => {
    const groupHistory = history.filter(h => {
      const p = getPeriodById(h.org.correctPeriod);
      return p && p.era === group.id;
    });
    if (groupHistory.length === 0) return;
    const gs = groupHistory.filter(h => h.correct).length;
    const gt = groupHistory.length;
    const card = document.createElement('div');
    card.className = 'era-score-card';
    card.style.cssText = `background:${group.barColor}22; border:1px solid ${group.barColor}44;`;
    card.innerHTML = `
      <div class="era-score-label" style="color:${group.textColor}">${group.name}</div>
      <div class="era-score-num" style="color:${group.textColor}">${gs}<span>/${gt}</span></div>
    `;
    eb.appendChild(card);
  });

  // History list
  const hl = document.getElementById('historyList');
  hl.innerHTML = '';
  history.forEach(h => {
    const selPeriod = getPeriodById(h.selected);
    const corrPeriod = getPeriodById(h.org.correctPeriod);
    const item = document.createElement('div');
    item.className = 'history-item ' + (h.correct ? 'correct' : 'wrong');
    item.innerHTML = `
      <div class="history-icon">${h.correct ? 'âœ“' : 'âœ—'}</div>
      <div class="history-emoji">${h.org.emoji}</div>
      <div class="history-body">
        <div class="history-name">${h.org.name}</div>
        <div class="history-answer">
          æ­£è§£ï¼š${corrPeriod ? corrPeriod.name : ''}ï¼ˆ${h.org.periodLabel}ï¼‰
          ${!h.correct ? `<span class="wrong-ans"> ï¼ ã‚ãªãŸã®å›ç­”ï¼š${selPeriod ? selPeriod.name : 'ï¼Ÿ'}</span>` : ''}
        </div>
      </div>
      ${h.org.isIndexFossil ? '<div class="history-index-badge">ç¤ºæº–åŒ–çŸ³</div>' : ''}
    `;
    hl.appendChild(item);
  });

  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function restartQuiz() {
  init();
  window.scrollTo({ top: 0 });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Start
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
init();
</script>
</body>
</html>
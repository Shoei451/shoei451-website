<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>古典常識カード</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@300;400;600;700&family=Noto+Sans+JP:wght@300;400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css">
</head>
<body>

<!-- ── HEADER ── -->
<header class="site-header">
  <div class="header-inner">
    <span class="header-mon">&#x25D0;</span>
    <span class="header-title">古典常識カード</span>
    <div class="header-tabs">
      <button class="h-tab active" id="htab-study"  onclick="switchMode('study')">学習</button>
      <button class="h-tab"        id="htab-editor" onclick="switchMode('editor')">編集</button>
    </div>
  </div>
  <div class="filter-bar" id="filterBar">
    <div class="filter-group">
      <span class="filter-label">カテゴリー</span>
      <button class="chip active" data-cat="all">すべて</button>
      <button class="chip" data-cat="rhetoric">和歌の修辞</button>
      <button class="chip" data-cat="rank">貴族の位</button>
      <button class="chip" data-cat="lit">文学史</button>
    </div>
    <div class="filter-right">
      <span id="deckCount" class="deck-count-text">--枚</span>
      <button class="btn-icon" onclick="shuffleDeck()" title="シャッフル">&#x21C4;</button>
      <button class="btn-icon" onclick="restartDeck()" title="最初から">&#x21BA;</button>
    </div>
  </div>
</header>

<!-- ══════════════ STUDY MODE ══════════════ -->
<div class="mode-panel active" id="mode-study">

  <div class="sb-banner" id="sbBanner" style="display:none">
    <span id="sbBannerText"></span>
    <button onclick="closeBanner()" class="banner-close">&#x2715;</button>
  </div>

  <div class="progress-strip">
    <div class="progress-fill" id="progressFill"></div>
  </div>

  <div class="deck-nav-row">
    <button class="nav-btn" id="prevBtn" onclick="prevCard()">&#x2039;</button>
    <div class="deck-indicator-group">
      <span id="deckIndicator" class="deck-indicator">1 / --</span>
      <div class="mastery-dots" id="masteryDots"></div>
    </div>
    <button class="nav-btn" id="nextBtn" onclick="nextCard()">&#x203A;</button>
  </div>

  <div class="card-scene" onclick="flipCard()">
    <div class="card-body" id="cardBody">

      <div class="card-face card-front">
        <div class="card-face-inner">
          <div class="face-top">
            <span class="face-badge" id="frontBadge"></span>
            <span class="face-hint">タップして答えを確認</span>
          </div>
          <img id="cardImage" class="card-image" src="" alt="" style="display:none">
          <p class="card-question" id="cardQuestion"></p>
          <span class="card-watermark">問</span>
        </div>
      </div>

      <div class="card-face card-back">
        <div class="card-face-inner">
          <div class="face-top">
            <span class="face-badge back-badge" id="backBadge"></span>
          </div>
          <p class="card-answer"      id="cardAnswer"></p>
          <p class="card-explanation" id="cardExplanation"></p>
          <span class="card-watermark back-watermark">答</span>
        </div>
      </div>

    </div>
  </div>

  <div class="mastery-row" id="masteryRow">
    <button class="mastery-btn m-forgot" onclick="markCard('forgot')">
      <span class="mi">&#x2715;</span><span class="ml">わからない</span>
    </button>
    <button class="mastery-btn m-unsure" onclick="markCard('unsure')">
      <span class="mi">&#x25B3;</span><span class="ml">あやふや</span>
    </button>
    <button class="mastery-btn m-knew" onclick="markCard('knew')">
      <span class="mi">&#x2713;</span><span class="ml">わかった</span>
    </button>
  </div>

  <p class="kb-hint">
    &#x2190;&#x2192; 移動 &nbsp;|&nbsp; Space 裏返す &nbsp;|&nbsp; 1&#x2715; 2&#x25B3; 3&#x2713;
  </p>

  <div class="complete-overlay" id="completeOverlay" style="display:none">
    <div class="complete-card">
      <div class="complete-icon">&#x25D0;</div>
      <h2 class="complete-title">一周完了</h2>
      <div class="complete-stats" id="completeStats"></div>
      <div class="complete-actions">
        <button class="btn-secondary" onclick="reviewWeak()">&#x2715;&#x25B3; のみ復習</button>
        <button class="btn-primary"   onclick="restartDeck()">最初から</button>
      </div>
    </div>
  </div>

  <div class="list-toggle" id="listToggle" onclick="toggleList()">
    <span>一覧</span><span id="listArrow">&#x203A;</span>
  </div>
  <div class="list-panel" id="listPanel">
    <div class="list-head">カード一覧</div>
    <div class="list-body" id="listBody"></div>
  </div>

</div><!-- /mode-study -->

<!-- ══════════════ EDITOR MODE ══════════════ -->
<div class="mode-panel" id="mode-editor">
  <div class="editor-wrap">

    <section class="editor-section">
      <h3 class="section-title">Supabase 接続設定</h3>
      <p class="section-desc">
        接続すると問題データを Supabase から取得します。<br>
        未設定の場合はローカルデータを使用します。
      </p>
      <div class="sb-config-grid">
        <div class="form-row">
          <label>Project URL</label>
          <input type="text" id="sb_url" placeholder="https://xxxxxxxxxxxxxx.supabase.co">
        </div>
        <div class="form-row">
          <label>Anon Key</label>
          <input type="text" id="sb_key" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
        </div>
      </div>
      <div class="sb-actions">
        <button class="btn-primary"   onclick="connectSupabase()" style="padding:10px 24px">接続して読み込む</button>
        <button class="btn-secondary" onclick="clearSupabase()">設定をクリア</button>
        <span class="sb-status" id="sbStatus"></span>
      </div>
      <div class="sb-schema-hint">
        <p class="schema-label">Supabase テーブル定義（<code>questions</code>）</p>
        <pre class="schema-sql">CREATE TABLE questions (
  id          SERIAL PRIMARY KEY,
  category    TEXT NOT NULL,  -- 'rhetoric' | 'rank' | 'lit'
  question    TEXT NOT NULL,
  answer      TEXT NOT NULL,
  explanation TEXT,
  image_url   TEXT
);</pre>
      </div>
    </section>

    <section class="editor-section">
      <h3 class="section-title" id="formTitle">問題を追加</h3>
      <div class="q-form">
        <div class="form-row">
          <label>カテゴリー</label>
          <select id="f_category">
            <option value="rhetoric">和歌の修辞</option>
            <option value="rank">貴族の位</option>
            <option value="lit">文学史</option>
          </select>
        </div>
        <div class="form-row">
          <label>問題文</label>
          <textarea id="f_question" placeholder="〜は何か？　〜の作者は？　など直接答えを問う形で"></textarea>
        </div>
        <div class="form-row">
          <label>答え</label>
          <input type="text" id="f_answer" placeholder="簡潔な正解">
        </div>
        <div class="form-row">
          <label>解説（任意）</label>
          <textarea id="f_explanation" placeholder="補足・背景説明"></textarea>
        </div>
        <div class="form-row">
          <label>画像 URL（任意）</label>
          <input type="text" id="f_imageUrl" placeholder="https://..." oninput="previewImage()">
          <input type="file"  id="f_imageFile" accept="image/*" onchange="handleImageFile()" style="margin-top:5px;font-size:0.8rem">
          <div id="imagePreview" class="image-preview"></div>
        </div>
        <div class="form-btns">
          <button class="btn-secondary" onclick="resetForm()">クリア</button>
          <button class="btn-primary"   onclick="saveQuestion()">保存する</button>
        </div>
      </div>
    </section>

    <section class="editor-section">
      <h3 class="section-title">エクスポート</h3>
      <div class="export-row">
        <button class="btn-secondary" onclick="exportCSV()">&#x21E9; CSV（Supabase インポート用）</button>
        <button class="btn-secondary" onclick="exportJSON()">&#x21E9; JSON</button>
      </div>
      <p class="section-desc" style="margin-top:8px">
        Supabase の Table Editor &rarr; Import data from CSV でインポートできます。
      </p>
    </section>

    <section class="editor-section">
      <h3 class="section-title">
        問題一覧
        <span class="section-count" id="qListCount"></span>
      </h3>
      <div class="q-list" id="qList"></div>
    </section>

  </div>
</div><!-- /mode-editor -->

<div class="toast" id="toast"></div>
<script src="app.js"></script>
</body>
</html>

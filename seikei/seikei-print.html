<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¿æ²»ãƒ»çµŒæ¸ˆ å­¦ç¿’ç”¨ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¹´è¡¨ (å°åˆ·ç”¨)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @media print {
            @page {
                size: A4;
                margin: 15mm;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Noto Sans JP", "Yu Gothic", "Meiryo", sans-serif;
            font-size: 11pt;
            line-height: 1.5;
            color: #000;
            background: #fff;
        }

        .print-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #1A2B3C;
        }

        .print-header h1 {
            font-size: 20pt;
            color: #1A2B3C;
            margin-bottom: 5px;
        }

        .print-info {
            font-size: 9pt;
            color: #666;
            margin-top: 5px;
        }

        .category-section {
            page-break-inside: avoid;
            margin-bottom: 30px;
        }

        .category-header {
            background: #1A2B3C;
            color: #fff;
            padding: 8px 12px;
            font-size: 13pt;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .timeline-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .timeline-table th {
            background: #f5f5f5;
            border: 1px solid #333;
            padding: 8px;
            text-align: left;
            font-weight: bold;
            font-size: 10pt;
        }

        .timeline-table td {
            border: 1px solid #666;
            padding: 8px;
            vertical-align: top;
        }

        .timeline-table tbody tr {
            page-break-inside: avoid;
        }

        .event-date {
            font-weight: bold;
            white-space: nowrap;
            width: 100px;
        }

        .event-category {
            width: 80px;
            font-size: 9pt;
        }

        .event-title {
            font-weight: 600;
            width: 200px;
        }

        .event-description {
            font-size: 10pt;
            color: #333;
        }

        .category-chip {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 9pt;
            font-weight: 600;
            white-space: nowrap;
        }

        .category-chip.å›½éš›æ”¿æ²» {
            background: #E3F2FD;
            color: #1565C0;
        }

        .category-chip.å›½éš›çµŒæ¸ˆ {
            background: #FFF9C4;
            color: #F57F17;
        }

        .category-chip.å›½å†…æ”¿æ²» {
            background: #BBDEFB;
            color: #0D47A1;
        }

        .category-chip.æ—¥éŠ€é‡‘èæ”¿ç­– {
            background: #E8F5E9;
            color: #2E7D32;
        }

        .category-chip.è¾²æ¥­ {
            background: #F1F8E9;
            color: #558B2F;
        }

        .category-chip.æ¶ˆè²»è€…ç”Ÿæ´»ãƒ»å…¬å®³å¯¾ç­– {
            background: #E0F2F1;
            color: #00695C;
        }

        .category-chip.åŠ´åƒå•é¡Œ {
            background: #FCE4EC;
            color: #C2185B;
        }

        .category-chip.ç¤¾ä¼šä¿éšœ {
            background: #FFF3E0;
            color: #E65100;
        }
        

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 14pt;
        }

        .controls {
            margin: 20px 0;
            text-align: center;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .controls button,
        .controls select {
            padding: 10px 20px;
            font-size: 11pt;
            border: 2px solid #1A2B3C;
            background: #fff;
            color: #1A2B3C;
            cursor: pointer;
            border-radius: 5px;
            font-weight: 600;
        }

        .controls button:hover {
            background: #1A2B3C;
            color: #fff;
        }

        @media screen {
            body {
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
            }
        }

        @media print {
            .controls {
                display: none !important;
            }

            .print-header {
                margin-bottom: 15px;
            }

            .category-section {
                margin-bottom: 25px;
            }
        }
    </style>
</head>
<body>
    <div class="controls">
        <select id="categoryFilter">
            <option value="all">ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒª</option>
            <option value="å›½éš›æ”¿æ²»">å›½éš›æ”¿æ²»</option>
            <option value="å›½éš›çµŒæ¸ˆ">å›½éš›çµŒæ¸ˆ</option>
            <option value="å›½å†…æ”¿æ²»">å›½å†…æ”¿æ²»</option>
            <option value="æ—¥éŠ€é‡‘èæ”¿ç­–">æ—¥éŠ€é‡‘èæ”¿ç­–</option>
            <option value="è¾²æ¥­">è¾²æ¥­</option>
            <option value="æ¶ˆè²»è€…ç”Ÿæ´»ãƒ»å…¬å®³å¯¾ç­–">æ¶ˆè²»è€…ç”Ÿæ´»ãƒ»å…¬å®³å¯¾ç­–</option>
            <option value="åŠ´åƒå•é¡Œ">åŠ´åƒå•é¡Œ</option>
            <option value="ç¤¾ä¼šä¿éšœ">ç¤¾ä¼šä¿éšœ</option>
        </select>
        <button onclick="window.print()">ğŸ–¨ï¸ å°åˆ·</button>
    </div>

    <div class="print-header">
        <h1>æ”¿æ²»ãƒ»çµŒæ¸ˆ å­¦ç¿’ç”¨ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¹´è¡¨</h1>
        <div class="print-info" id="printDate"></div>
    </div>

    <div id="timelineContainer">
        <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <script>
        // Supabase Configuration - REPLACE WITH YOUR CREDENTIALS
        const SUPABASE_URL = 'https://gjuqsyaugrsshmjerhme.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdqdXFzeWF1Z3Jzc2htamVyaG1lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0NzA3NTYsImV4cCI6MjA4MjA0Njc1Nn0.V8q5ddz5tPy7wBaQ73aGtmCZyqzA6pPciPRwRIZjJcs';
        
        const printApiClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let events = [];
        let selectedCategory = 'all';

        // Set print date
        document.getElementById('printDate').textContent = 
            `å°åˆ·æ—¥: ${new Date().toLocaleDateString('ja-JP', {year: 'numeric', month: 'long', day: 'numeric'})}`;

        // Load events
        async function loadEvents() {
            try {
                const { data, error } = await printApiClient
                    .from('seikei_events')
                    .select('*')
                    .order('date', { ascending: true });

                if (error) throw error;
                events = data || [];
                renderTimeline();
            } catch (error) {
                console.error('Error loading events:', error);
                document.getElementById('timelineContainer').innerHTML = `
                    <p style="text-align: center; color: #666;">
                        âš ï¸ ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ<br>
                        Supabaseã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„
                    </p>
                `;
            }
        }

        // Render timeline grouped by category
        function renderTimeline() {
            const container = document.getElementById('timelineContainer');
            
            const filteredEvents = selectedCategory === 'all' 
                ? events 
                : events.filter(e => e.category === selectedCategory);

            if (filteredEvents.length === 0) {
                container.innerHTML = '<p style="text-align: center;">ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            // If "all categories" is selected, show unified table with color-coded chips
            if (selectedCategory === 'all') {
                const tableHTML = `
                    <table class="timeline-table">
                        <thead>
                            <tr>
                                <th style="width: 100px;">æ—¥ä»˜</th>
                                <th style="width: 120px;">ã‚«ãƒ†ã‚´ãƒª</th>
                                <th style="width: 200px;">ã‚¤ãƒ™ãƒ³ãƒˆå</th>
                                <th>èª¬æ˜</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredEvents.map(event => `
                                <tr>
                                    <td class="event-date">${formatDate(event.date, event.date_type)}</td>
                                    <td><span class="category-chip ${escapeHtml(event.category)}">${escapeHtml(event.category)}</span></td>
                                    <td class="event-title">${escapeHtml(event.title)}</td>
                                    <td class="event-description">${escapeHtml(event.description || '')}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                container.innerHTML = tableHTML;
                return;
            }

            // For specific category, group by category sections
            const categories = {};
            filteredEvents.forEach(event => {
                if (!categories[event.category]) {
                    categories[event.category] = [];
                }
                categories[event.category].push(event);
            });

            let html = '';

            // Render each category section
            Object.keys(categories).sort().forEach(category => {
                html += `
                    <div class="category-section">
                        <div class="category-header">${category}</div>
                        <table class="timeline-table">
                            <thead>
                                <tr>
                                    <th>æ—¥ä»˜</th>
                                    <th>ã‚¤ãƒ™ãƒ³ãƒˆå</th>
                                    <th>èª¬æ˜</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${categories[category].map(event => `
                                    <tr>
                                        <td class="event-date">${formatDate(event.date, event.date_type)}</td>
                                        <td class="event-title">${escapeHtml(event.title)}</td>
                                        <td class="event-description">${escapeHtml(event.description || '')}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Format date
        function formatDate(dateString, dateType) {
            if (!dateString) return '';
            
            // If it's year-only (dateType is 'year' or date is in format 'YYYY-01-01')
            if (dateType === 'year' || dateString.endsWith('-01-01')) {
                return dateString.substring(0, 4) + 'å¹´';
            }
            
            const date = new Date(dateString);
            return `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Category filter
        document.getElementById('categoryFilter').addEventListener('change', (e) => {
            selectedCategory = e.target.value;
            renderTimeline();
        });

        // Initialize
        loadEvents();
    </script>
</body>
</html>